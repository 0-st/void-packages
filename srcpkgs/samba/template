# Template file for 'samba'
pkgname=samba
version=3.6.3
build_wrksrc=source3
distfiles="http://us1.samba.org/samba/ftp/stable/$pkgname-$version.tar.gz"
build_style=gnu-configure
configure_args="--with-fhs --with-pam --with-pam_smbpass --with-ldap
--with-configdir=/etc/samba --with-lockdir=/var/samba
--with-cachedir=/var/samba --with-nmbdsocketdir=/run/samba/socket
--with-statedir=/var/samba --with-piddir=/run/samba --with-dnsupdate
--with-pammodulesdir=/lib/security --with-automount --disable-swat
--with-syslog --enable-external-libtalloc --with-quotas --disable-cups
--enable-external-libtdb --disable-fam --with-ads --with-acl-support
--with-shared-modules=idmap_ad,idmap_adex,idmap_rid,idmap_hash,idmap_tdb2"
short_desc="SMB/CIFS file, print, and login server for Unix"
maintainer="Juan RP <xtraeme@gmail.com>"
checksum=67e2409f2d5e4d5cb947c95f583498105038857b84cc73c08dacd4e2cbc66074
long_desc="
 Samba is an implementation of the SMB/CIFS protocol for Unix systems,
 providing support for cross-platform file and printer sharing with Microsoft
 Windows, OS X, and other Unix systems. Samba can also function as an
 NT4-style domain controller, and can integrate with both NT4 domains and
 Active Directory realms as a member server."

# Require a newer libsmclient.
shlib_depends="libsmbclient>=${version}"
subpackages="smbclient libsmbclient samba-devel"

# Don't restart services automatically.
systemd_services="
nmbd.service off
smbd.service off
winbindd.service off"

conf_files="/etc/samba/smb.conf /etc/pam.d/samba"

Add_dependency run smbclient

Add_dependency build gettext
Add_dependency build perl
Add_dependency build readline-devel
Add_dependency build python-devel
Add_dependency build libcap-devel
Add_dependency build popt-devel
Add_dependency build e2fsprogs-devel
Add_dependency build mit-krb5-devel
Add_dependency build libldap-devel
Add_dependency build pam-devel
Add_dependency build acl-devel
Add_dependency build avahi-libs-devel
Add_dependency build tdb-devel
Add_dependency build talloc-devel

post_install() {
	# conf file
	cat examples/smb.conf.default | \
		sed 's|log file = .*$|log file = /var/log/samba/%m.log|g' > \
		${DESTDIR}/etc/samba/smb.conf

	# fix logrotate
	sed -i -e 's|log.%m|%m.log|g' ${DESTDIR}/etc/samba/smb.conf

	# fix spool directory
	sed -i 's|/usr/spool/samba|/var/spool/samba|g' \
		${DESTDIR}/etc/samba/smb.conf

	# nsswitch libraries
	vinstall nsswitch/libnss_wins.so 755 lib
	ln -s libnss_wins.so ${DESTDIR}/lib/libnss_wins.so.2

	vinstall nsswitch/libnss_winbind.so 755 lib
	ln -s libnss_winbind.so ${DESTDIR}/lib/libnss_winbind.so.2

	# winbind krb5 locator
	vinstall source3/bin/winbind_krb5_locator.so 755 \
		usr/lib/krb5/plugins/libkrb5

	# Remove unused manpages
	rm -f ${DESTDIR}/usr/share/man/man8/tdb*
	rm -f ${DESTDIR}/usr/share/man/man8/swat*

	# systemd units
	for f in nmbd smbd winbindd; do
		vinstall ${FILESDIR}/${f}.service 644 lib/systemd/system
	done
	# systemd tmpfiles
	vinstall ${FILESDIR}/samba.tmpfiles 644 usr/lib/tmpfiles.d samba.conf

	# PAM support
	vinstall ${FILESDIR}/samba.pam 644 etc/pam.d samba

	# logrotate file
	vinstall ${FILESDIR}/samba.logrotate 644 etc/logrotate.d samba
}
