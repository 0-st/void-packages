# Template file for 'xbmc'
pkgname=xbmc
version=9.11
patch_args="-Np1"
distfiles="${SOURCEFORGE_SITE}/$pkgname/$pkgname-$version.tar.gz"
build_style=gnu_configure
short_desc="XBMC Media Center"
configure_args="--disable-external-liba52 --disable-external-libdts
--enable-external-libmpeg2 --enable-external-libogg --enable-goom
--enable-external-libwavpack --disable-external-libass  --enable-gl
--disable-external-ffmpeg --disable-debug --disable-external-python"
make_install_target="prefix=${XBPS_DESTDIR}/${pkgname}-${version}/usr install"
maintainer="Juan RP <xtraeme@gmail.com>"
checksum=e810aaaf1c380bbe923d9e30e2e472577081b7b893e12a7ef4bb70a911c3db87
long_desc="
 XBMC is an award-winning free and open source (GPL) software media player
 and entertainment hub for digital media. XBMC is available for Linux, OSX,
 Windows, and the original Xbox."

Add_dependency run glibc
Add_dependency run libXmu
Add_dependency run libstdc++
Add_dependency run libgcc
Add_dependency run libpng
Add_dependency run libjasper
Add_dependency run jpeg
Add_dependency run tiff
Add_dependency run zlib
Add_dependency run libXrandr
Add_dependency run libXrender
Add_dependency run libX11
Add_dependency run libwavpack
Add_dependency run libmpeg2
Add_dependency run avahi-libs
Add_dependency run faac
Add_dependency run libpulseaudio
Add_dependency run SDL_image
Add_dependency run SDL_mixer
Add_dependency run libsmbclient
Add_dependency run faad2
Add_dependency run libssl
Add_dependency run lzo
Add_dependency run libmysqlclient
Add_dependency run MesaLib
Add_dependency run glew
Add_dependency run libmad
Add_dependency run fontconfig
Add_dependency run fribidi
Add_dependency run sqlite
Add_dependency run libpcre
Add_dependency run libcdio
Add_dependency run glib
Add_dependency run freetype
Add_dependency run libogg
Add_dependency run libvorbis
Add_dependency run alsa-lib
Add_dependency run libenca
Add_dependency run libXt
Add_dependency run libXtst
Add_dependency run libXinerama
Add_dependency run libcurl
Add_dependency run dbus-libs
Add_dependency run libhal
Add_dependency run SDL
Add_dependency run libXext

Add_dependency build pkg-config
Add_dependency build automake
Add_dependency build libXmu-devel
Add_dependency build libstdc++-devel
Add_dependency build libpng-devel
Add_dependency build jasper-devel
Add_dependency build jpeg-devel
Add_dependency build tiff-devel
Add_dependency build zlib-devel
Add_dependency build libXrandr-devel
Add_dependency build libXrender-devel
Add_dependency build libX11-devel
Add_dependency build wavpack-devel
Add_dependency build libmpeg2-devel
Add_dependency build avahi-libs-devel
Add_dependency build faac-devel
Add_dependency build pulseaudio-devel
Add_dependency build SDL_image-devel
Add_dependency build SDL_mixer-devel
Add_dependency build samba-devel
Add_dependency build faad2-devel
Add_dependency build openssl-devel
Add_dependency build lzo-devel
Add_dependency build libmysqlclient-devel
Add_dependency build MesaLib-devel
Add_dependency build glew-devel
Add_dependency build libmad-devel
Add_dependency build fontconfig-devel
Add_dependency build fribidi-devel
Add_dependency build sqlite-devel
Add_dependency build pcre-devel
Add_dependency build libcdio-devel
Add_dependency build glib-devel
Add_dependency build freetype-devel
Add_dependency build libogg-devel
Add_dependency build libvorbis-devel
Add_dependency build alsa-lib-devel
Add_dependency build enca-devel
Add_dependency build libXt-devel
Add_dependency build libXtst-devel
Add_dependency build libXinerama-devel
Add_dependency build libcurl-devel
Add_dependency build dbus-devel
Add_dependency build libhal-devel
Add_dependency build SDL-devel
Add_dependency build libXext-devel

Add_dependency full desktop-file-utils
Add_dependency full mesa-demos # required glxinfo

pre_configure()
{
	cd ${wrksrc} && ./bootstrap || return 1
	sed -i -e 's:/usr/bin/lsb_release -d:/bin/true:' xbmc/utils/SystemInfo.cpp
	sed -i 's: ftell64: dll_ftell64:' xbmc/cores/DllLoader/exports/wrapper.c
	sed -i 's|cinfo.scale_denom = GetJpegScale();|cinfo.scale_denom = GetJpegScale(); cinfo.scale_num = 1;|' \
		xbmc/lib/cximage-6.0/CxImage/ximajpg.cpp
}

post_install()
{
	# Fix files containing invalid chars "&".
	find ${DESTDIR} -type f | while read f; do
		if $(echo "$f"|grep -q "&"); then
			newf=$(echo "$f"|sed -e "s|&|and|g")
			mv "$f" "$newf"
		fi
	done
	# Fix path to xbmc.
	sed -i "s#Exec=xbmc#Exec=/usr/bin/xbmc#" ${DESTDIR}/usr/share/applications/xbmc.desktop
}
