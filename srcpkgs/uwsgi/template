# Template file for 'uwsgi'
pkgname=uwsgi
version=2.0.11.1
revision=5
hostmakedepends="python python3.4"
makedepends="python-devel python3.4-devel"
short_desc="Fast, self-healing application container server"
maintainer="Eivind Uggedal <eivind@uggedal.com>"
license="GPL-2"
homepage="http://projects.unbit.it/uwsgi"
distfiles="http://projects.unbit.it/downloads/uwsgi-$version.tar.gz"
checksum=75a7d3138cfa9cd81a760c2f8a43f3d80961edc8e4f27043dc1412206c926287

_libdir=usr/lib/uwsgi

# XXX
nocross="http://build.voidlinux.eu/builders/armv7l_builder/builds/16129/steps/shell_3/logs/stdio"

pre_configure() {
	sed -e "s|uc.get('plugin_dir')|'.'|" \
		-i uwsgiconfig.py
	sed -e "s|\(plugin_dir =\).*|\1 /$_libdir|" \
		-i buildconf/base.ini
}

do_build() {
	python uwsgiconfig.py --build core
	python uwsgiconfig.py --plugin plugins/python core python
	python3.4 uwsgiconfig.py --plugin plugins/python core python3
}

do_install() {
	mkdir -p $PKGDESTDIR/usr/bin $PKGDESTDIR/$_libdir
	cp uwsgi $PKGDESTDIR/usr/bin
	cp *_plugin.so $PKGDESTDIR/$_libdir
}

uwsgi-python_package() {
	short_desc="$short_desc (Python2 plugin)"
    	pkg_install() {
        	vmove $_libdir/python_plugin.so
    	}
}

uwsgi-python3.4_package() {
	short_desc="$short_desc (Python3.4 plugin)"
    	pkg_install() {
        	vmove $_libdir/python3_plugin.so
    	}
}
