# Template file for 'lightdm'
pkgname=lightdm
version=1.4.0
revision=3
build_style=gnu-configure
configure_args="--with-greeter-session=lightdm-gtk-greeter
 --with-greeter-user=lightdm --disable-static --disable-tests"
fulldepends="gnome-icon-theme dbus"
short_desc="Light Display Manager"
maintainer="Juan RP <xtraeme@gmail.com>"
license="GPL-3, LGPL-3"
homepage="https://launchpad.net/lightdm"
distfiles="https://launchpad.net/lightdm/1.4/$version/+download/$pkgname-$version.tar.gz"
checksum=3486a9f828864a78d452696cf6fef6e1dec2f4ef92a72e90ab37edf9a0824c43
long_desc="
 An X display manager that:
  * Has a lightweight codebase
  * Is standards compliant (PAM, ConsoleKit, etc)
  * Has a well defined interface between the server and user interface
  * Fully themeable (easiest with the webkit interface)
  * Cross-desktop (greeters can be written in any toolkit)"

depends="accountsservice upower"
makedepends="pkg-config intltool dbus-glib-devel libxklavier-devel libxml2-devel
 qt-devel gtk+3-devel libxcb-devel libXdmcp-devel pam-devel vala-devel
 gobject-introspection itstool"

conf_files="
/etc/lightdm/keys.conf
/etc/lightdm/lightdm.conf
/etc/lightdm/users.conf
/etc/pam.d/lightdm
/etc/pam.d/lightdm-autologin"

system_accounts="lightdm"
lightdm_homedir="/var/cache/lightdm"
systemd_services="lightdm.service off"
make_dirs="/var/cache/lightdm 0755 lightdm lightdm"
subpackages="liblightdm-gobject liblightdm-qt lightdm-devel"

post_install() {
	# Remove provided init file and use our own.
	rm -rf ${DESTDIR}/etc/init
	vinstall ${FILESDIR}/lightdm.service 644 usr/lib/systemd/system
	vinstall ${FILESDIR}/lightdm.pam 644 etc/pam.d lightdm
	vinstall ${FILESDIR}/lightdm-autologin.pam 644 etc/pam.d lightdm-autologin
	vinstall ${FILESDIR}/xsession 755 etc/lightdm

	vinstall ${FILESDIR}/lightdm.rules 644 usr/share/polkit-1/rules.d

	# Minimum UID shall be 1000 for ordinary users.
	sed -i -e "s|^\(minimum-uid=\).*|\11000|" \
		${DESTDIR}/etc/lightdm/users.conf
	# Fix path to nologin.
	sed -i -e "s|/usr/sbin/nologin|/sbin/nologin|g" \
		${DESTDIR}/etc/lightdm/users.conf
	# Provide a working session wrapper.
	sed -i -e "s|#session-wrapper=lightdm-session|session-wrapper=/etc/lightdm/xsession|g" \
		${DESTDIR}/etc/lightdm/lightdm.conf
	# Provide a working PAM autologin service.
	sed -i -e "s|#autologin-session=UNIMPLEMENTED|#autologin-session=UNIMPLEMENTED\n#pam-service=lightdm-autologin|g" \
		${DESTDIR}/etc/lightdm/lightdm.conf
}
