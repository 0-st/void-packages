# Template file for 'odroid-u2-uboot'
_githash=50140a35514f845a574bb21a8db04076c505bb42
pkgname=odroid-u2-uboot
version=v2012.07
revision=1
wrksrc="u-boot-${_githash}"
hostmakedepends="uboot-mkimage"
short_desc="Odroid U2 U-Boot files for SD booting"
maintainer="Enno Boland <eb@s01.de>"
license="GPL-2"
homepage="https://github.com/hardkernel/u-boot"
distfiles="https://github.com/hardkernel/u-boot/archive/${_githash}.tar.gz
	http://dev.odroid.com/projects/4412boot/wiki/FrontPage?action=download&value=boot.tar.gz"
checksum="6478856a6c694f0718fe45dc4c1dc01d5cd1cfaca417ce047fc0619ccb0c0332
	e0db737d9e49f937425e4778b0ab892623bcc389d7c26329ba2e97ae7bb475c4"

create_srcdir=yes
only_for_archs="armv7l"

_default_scr="boot-auto_edid.scr"

do_configure() {
	patch -p1 < ${FILESDIR}/smc.patch
	patch -p1 < ${FILESDIR}/config.patch
	make smdk4412_config
}

do_build() {
	unset CFLAGS CXXFLAGS LDFLAGS
  
	if [ "$CROSS_BUILD" ]; then
		make ARCH=arm CROSS_COMPILE=${XBPS_CROSS_TRIPLET}-
	else
		make ARCH=arm
	fi

	# Building uboot scr's
	for source in ${FILESDIR}/*.ini; do
		name=$(basename ${source%.ini})
		mkimage -A arm -T script -C none -n "${name}" -d $source ${name}.scr
	done

	cp ${_default_scr} boot.scr
}

do_install() {
	vinstall ${XBPS_BUILDDIR}/boot/E4412_S.bl1.HardKernel.bin 600 boot
	vinstall ${XBPS_BUILDDIR}/boot/bl2.signed.bin 600 boot
	vinstall ${XBPS_BUILDDIR}/boot/E4412_S.tzsw.signed.bin 600 boot
	vinstall u-boot.bin 600 boot

	# Install uboot scr's
	for scr in *.scr; do
		echo $scr
		vinstall $scr 600 boot
	done
}
