# Template file for 'postfix'
pkgname=postfix
version=2.9.3
revision=1
makedepends="perl openssl-devel db-devel pcre-devel>=8.30 libsasl-devel
libldap-devel libmysqlclient-devel postgresql-libs-devel sqlite-devel"
short_desc="High-performance mail transport agent"
maintainer="Juan RP <xtraeme@gmail.com>"
license="IBM Public License 1.0, BSD-alike"
homepage="http://www.postfix.org/"
distfiles="ftp://ftp.porcupine.org/mirrors/postfix-release/official/$pkgname-$version.tar.gz"
checksum=3b4ae6d7715ccd23396d83a65ad83c7639065a125c87393013cc0514186a55da
long_desc="
 It is Wietse Venema's mail server that started life at IBM research as an
 alternative to the widely-used Sendmail program.

 Postfix attempts to be fast, easy to administer, and secure. The outside has
 a definite Sendmail-ish flavor, but the inside is completely different."

conf_files="
/etc/postfix/access
/etc/postfix/aliases
/etc/postfix/canonical
/etc/postfix/generic
/etc/postfix/header_checks
/etc/postfix/main.cf
/etc/postfix/master.cf
/etc/postfix/relocated
/etc/postfix/transport
/etc/postfix/virtual"

make_dirs="
/var/lib/postfix		0750	postfix	root
/var/spool/postfix/active	0750	postfix	root
/var/spool/postfix/bounce	0750	postfix	root
/var/spool/postfix/corrupt	0750	postfix	root
/var/spool/postfix/defer	0750	postfix	root
/var/spool/postfix/deferred	0750	postfix	root
/var/spool/postfix/flush	0750	postfix	root
/var/spool/postfix/hold		0750	postfix	root
/var/spool/postfix/incoming	0750	postfix	root
/var/spool/postfix/private	0750	postfix	root
/var/spool/postfix/maildrop	0750	postfix	postdrop
/var/spool/postfix/public	0750	postfix	postdrop
/var/spool/postfix/pid		0750	root	root
/var/spool/postfix/saved	0750	postfix	root
/var/spool/postfix/trace	0750	postfix	root"

systemd_services="postfix.service true"

system_accounts="postfix"
postfix_homedir="/var/spool/postfix"
system_groups="postdrop"

provides="smtp-server-0"
replaces="smtp-server>=0"


do_build() {
	make makefiles DEBUG='' CCARGS=' \
		-DUSE_SASL_AUTH -DUSE_CYRUS_SASL -I/usr/include/sasl \
		-DHAS_LDAP \
		-DUSE_TLS \
		-DHAS_MYSQL -I/usr/include/mysql \
		-DHAS_PGSQL -I/usr/include/postgresql \
		-DHAS_SQLITE \
	' AUXLIBS=' \
		-lsasl2 \
		-lldap -llber \
		-lssl -lcrypto \
		-lmysqlclient -lz -lm \
		-lpq \
		-lsqlite3 -lpthread \
	' OPT="${CFLAGS} ${LDFLAGS}"

	make ${makejobs}
}

do_install() {
	sh postfix-install -non-interactive \
		install_root="${DESTDIR}" \
		daemon_directory="/usr/lib/${pkgname}" \
		sample_directory="/etc/${pkgname}/sample" \
		manpage_directory="/usr/share/man"

	vinstall LICENSE 644 usr/share/licenses/${pkgname}
	vinstall TLS_LICENSE 644 usr/share/licenses/${pkgname}

	sed 's/\(^\$manpage[^:]*\):/\1.gz:/' -i \
		${DESTDIR}/usr/lib/${pkgname}/postfix-files
	cd ${DESTDIR}; patch -p0 -i ${FILESDIR}/aliases.patch

	# Remove unused stuff.
	rm -f ${DESTDIR}/etc/postfix/*LICENSE
	rm -f ${DESTDIR}/etc/postfix/*.default

	# systemd.
	vinstall ${FILESDIR}/postfix.service 644 usr/lib/systemd/system
}
