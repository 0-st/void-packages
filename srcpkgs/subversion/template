# Template file for 'subversion'
pkgname=subversion
version=1.7.8
revision=2
short_desc="Enterprise-class centralized version control for the masses"
maintainer="Juan RP <xtraeme@gmail.com>"
license="Apache-2.0, BSD"
distfiles="http://apache.mirror.rafal.ca/subversion/${pkgname}-${version}.tar.bz2"
homepage="http://subversion.apache.org/"
checksum=fc83d4d98ccea8b7bfa8f5c20fff545c8baa7d035db930977550c51c6ca23686

subpackages="${pkgname}-python ${pkgname}-perl ${pkgname}-apache
 ${pkgname}-gnome-keyring-auth ${pkgname}-devel libsvn"

depends="ca-certificates"

# XXX enable kwallet when kdelibs is available.
makedepends="pkg-config perl>=5.16 python-devel swig apr-util-devel
 libldap-devel db-devel gdbm-devel expat-devel apr-devel libuuid-devel
 sqlite-devel libsasl-devel dbus-devel libgnome-keyring-devel glib-devel
 neon-devel apache-devel"

do_configure() {
	./configure ${CONFIGURE_SHARED_ARGS} \
		--with-apxs --disable-javahl --disable-static \
		--without-kwallet --with-gnome-keyring --with-editor=vim \
		--disable-mod-activation
}

do_build() {
	make ${makejobs} external-all
	make ${makejobs} LT_LDFLAGS="-L$Fdestdir/usr/lib" local-all
	make ${makejobs} swig_pydir=/usr/lib/python2.7/site-packages/libsvn \
		swig_pydir_extra=/usr/lib/python2.7/site-packages/svn \
		swig-py swig-pl
}

do_install() {
	export LD_LIBRARY_PATH=${DESTDIR}/usr/lib:$LD_LIBRARY_PATH

	make DESTDIR=${DESTDIR} INSTALLDIRS=vendor \
		swig_pydir=/usr/lib/python2.7/site-packages/libsvn \
		swig_pydir_extra=/usr/lib/python2.7/site-packages/svn \
		install install-swig-py install-swig-pl

	vinstall ${FILESDIR}/svnserve.service 644 usr/lib/systemd/system
	vinstall ${FILESDIR}/svnserve.tmpfiles 644 usr/lib/tmpfiles.d svnserve.conf

	rm -rf ${DESTDIR}/usr/lib/perl5/core_perl
	vmkdir usr/share/subversion
	install -d -m755 tools/hook-scripts ${DESTDIR}/usr/share/subversion/
	rm -f ${DESTDIR}/usr/share/subversion/hook-scripts/*.in

	install -Dm644 tools/client-side/bash_completion \
		${DESTDIR}/usr/share/bash-completion/completions/subversion

	for i in svn svnadmin svndumpfilter svnlook svnsync svnversion; do
		ln -sf subversion ${DESTDIR}/usr/share/bash-completion/completions/${i}
	done
}
