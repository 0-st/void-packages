# Template file for 'coreutils'
pkgname=coreutils
version=8.21
revision=3
short_desc="The GNU core utilities"
maintainer="Juan RP <xtraeme@gmail.com>"
homepage="http://www.gnu.org/software/coreutils"
license="GPL-3"
distfiles="http://ftp.gnu.org/gnu/coreutils/${pkgname}-${version}.tar.xz"
checksum=adaa44bdab3fa5eb352e80d8a31fdbf957b78653d0c2cd30d63e161444288e18

subpackages="coreutils-doc"
conflicts="chroot-coreutils>=0 procps-ng<3.3.5_3"
hostmakedepends="perl"
makedepends="gmp-devel acl-devel libcap-devel"
depends="coreutils-doc-${version}_${revision}"

if [ "$XBPS_CROSS_BUILD" ]; then
	unset subpackages
fi

do_configure() {
	if [ "$XBPS_CROSS_BUILD" ]; then
		_confargs="fu_cv_sys_stat_statfs2_bsize=yes \
			gl_cv_func_working_mkstemp=yes
			gl_cv_func_working_acl_get_file=yes"
	fi
	#
	# Do not install kill: provided by util-linux.
	# Do not install uptime: provided by procps-ng.
	#
	./configure ${CONFIGURE_SHARED_ARGS} \
		--enable-install-program=hostname \
		--enable-no-install-program=kill,uptime \
		--disable-rpath ${_confargs}
}

do_build() {
	if [ "$XBPS_CROSS_BUILD" ]; then
		cp Makefile Makefile.orig
		sed '/src_make_prime_list/d' Makefile.orig > Makefile
		depbase=`echo src/make-prime-list.o | sed 's|[^/]*$|.deps/&|;s|\.o$||'`;\
			gcc -std=gnu99  -I. -I./lib  -Ilib -I./lib -Isrc -I./src  \
			-fdiagnostics-show-option -funit-at-a-time -g -O2 -MT \
			src/make-prime-list.o -MD -MP -MF $depbase.Tpo -c -o src/make-prime-list.o \
			src/make-prime-list.c &&
		mv -f $depbase.Tpo $depbase.Po
		gcc -std=gnu99 -fdiagnostics-show-option -funit-at-a-time -g -O2 \
			-Wl,--as-needed  -o src/make-prime-list src/make-prime-list.o
		cp Makefile Makefile.bak
		sed -e '/hostname.1/d' Makefile.bak > Makefile
	fi
	make ${makejobs}
}

do_install() {
	make DESTDIR=${DESTDIR} install

	if [ "$XBPS_CROSS_BUILD" ]; then
		rm -rf ${DESTDIR}/usr/share/info
	fi
}
