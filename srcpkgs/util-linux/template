# Template file for 'util-linux'
pkgname=util-linux
version=2.22
revision=1
depends="coreutils shadow>=4.1.5.1_3"
makedepends="pkg-config zlib-devel ncurses-devel pam-devel"
replaces="util-linux-ng>=0 e2fsprogs<=1.41.14_1 eject>=0 shadow<4.1.5.1_3"
provides="eject-${version}"
subpackages="libmount libmount-devel libblkid libblkid-devel libuuid libuuid-devel"
short_desc="Miscellaneous linux utilities"
maintainer="Juan RP <xtraeme@gmail.com>"
homepage="http://userweb.kernel.org/~kzak/util-linux-ng"
license="GPL-2"
distfiles="${KERNEL_SITE}/utils/${pkgname}/v2.22/${pkgname}-${version}.tar.xz"
checksum=32b329aa72c2ea546378bf81f08e30cf30440196c2edf7777b4f509a3fdbe5a2
long_desc="
 The ${pkgname} package contains miscellaneous utility programs. Among
 them are utilities for handling file systems, consoles, partitions,
 and messages."

# Create uuidd system account for uuidd.
system_accounts="uuidd"
uuidd_homedir="/run/uuidd"

systemd_services="uuidd.socket on"

conf_files="
/etc/pam.d/chfn
/etc/pam.d/chsh
/etc/pam.d/su
/etc/pam.d/login"

do_configure() {
	./configure --prefix=/usr --exec-prefix=/usr --libdir=/usr/lib \
		--bindir=/usr/bin --sbindir=/usr/sbin \
		--enable-libuuid --disable-makeinstall-chown \
		--enable-libblkid --enable-fsck --disable-rpath \
		--enable-fs-paths-extra=/usr/sbin:/usr/bin \
		--enable-vipw --enable-newgrp --enable-chfn-chsh \
		--with-systemdsystemunitdir=/usr/lib/systemd/system \
		--without-udev --enable-write --disable-kill \
		--enable-socket-activation \
		SUID_CFLAGS="-fPIE" SUID_LDFLAGS="-pie"
}

do_build() {
	make ${makejobs}
}

do_install() {
	make DESTDIR=${DESTDIR} install

	# pam login utils.
	vinstall $FILESDIR/login.pam 644 etc/pam.d login
	vinstall $FILESDIR/su.pam 644 etc/pam.d su
	vinstall $FILESDIR/common.pam 644 etc/pam.d chfn
	vinstall $FILESDIR/common.pam 644 etc/pam.d chsh

	# Provide sg(1) symlink.
	cd ${DESTDIR}/usr/bin && ln -sf newgrp sg
}
