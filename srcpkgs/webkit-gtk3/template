# Template file for 'webkit-gtk3'
pkgname=webkit-gtk3
version=1.8.2
revision=1
wrksrc=webkit-${version}
makedepends="automake perl pkg-config intltool which gperf bison25 flex
jpeg-devel libpng-devel>=1.5.10 sqlite-devel gtk+-devel gtk+3-devel
gst-plugins-base-devel libsoup-devel libxslt-devel icu-devel>=49
enchant-devel geoclue-devel gobject-introspection"
subpackages="webkit-gtk webkit-gtk-devel $pkgname-devel"
short_desc="GTK+3 port of the WebKit browser engine"
maintainer="Juan RP <xtraeme@gmail.com>"
homepage="http://webkitgtk.org/"
license="LGPL-2.1, Simplified BSD (2 clause)"
distfiles="${homepage}/releases/webkit-${version}.tar.xz"
checksum=0cd69b7c4bf4af3442a5e6777a1487cabf14db15baeeed96d0865419f69b81e6
long_desc="
 WebKit is an open source web browser engine. WebKit is also the name of
 the Mac OS X system framework version of the engine that's used by
 Safari, Dashboard, Mail, and many other OS X applications. WebKit's HTML
 and JavaScript code began as a branch of the KHTML and KJS libraries
 from KDE.

 This is the GTK3+ port of the engine."

do_configure() {
	autoreconf -fi -I Source/autotools

	local args="--enable-video --enable-jit \
		--with-font-backend=freetype --enable-introspection \
		--with-unicode-backend=icu --disable-schemas-compile \
		--with-accelerated-compositing=opengl \
		${CONFIGURE_SHARED_ARGS}"

	for ver in 2 3; do
		[ ! -d ${wrksrc}/build-gtk${ver} ] && \
			mkdir ${wrksrc}/build-gtk${ver}
		cd ${wrksrc}/build-gtk${ver}
		../configure ${args} --with-gtk=${ver}.0
	done
}

do_build() {
	for ver in 2 3; do
		msg_normal "Building GTK+${ver} version...\n"
		cd ${wrksrc}/build-gtk${ver}
		# Horrible hack to build in parallel (Gentoo)
		# see https://bugs.webkit.org/show_bug.cgi?id=79498
		make all-built-sources-local
		make ${makejobs} all-ltlibraries-local
		make ${makejobs} all-programs-local
		if [ "$ver" = "2" ]; then
			make ${makejobs} WebKit-1.0.gir
		else
			make ${makejobs} WebKit-3.0.gir
		fi
		make ${makejobs} all-data-local
	done
}

do_install() {
	for ver in 2 3; do
		msg_normal "Installing GTK+${ver} version...\n"
		cd ${wrksrc}/build-gtk${ver}
		make DESTDIR=${DESTDIR} install
	done
}
