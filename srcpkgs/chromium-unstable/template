# Template file for 'chromium-unstable'
__pkgname=chromium
pkgname=${__pkgname}-unstable
version=17.0.916.0
revision=5
distfiles="http://build.chromium.org/official/${__pkgname}-$version.tar.bz2"
short_desc="Google's attempt at creating a safer, faster, and more stable browser"
maintainer="davehome <davehome@redthumb.info.tm>"
homepage="http://www.chromium.org/"
license="BSD"
checksum=8c4b1c3746ac4283b2dbf7b2e51247baada6371d6c97f2b6db13185724fb4f86
long_desc="
 Chromium is an open-source browser project that aims to build a safer,
 faster, and more stable way for all Internet users to experience the web.

 Chromium serves as a base for Google Chrome, which is Chromium rebranded
 (name and logo) with very few additions such as usage tracking and an
 auto-updater system.

 This package contains the Chromium browser (unstable build)."

replaces="chromium>=0"
provides="chromium-$version"
build_requires=11

gtk_iconcache_dirs="/usr/share/icons/hicolor"

Add_dependency run desktop-file-utils
Add_dependency run hicolor-icon-theme

Add_dependency build pkg-config
Add_dependency build yasm
Add_dependency build flex
Add_dependency build gperf
Add_dependency build libXrender-devel
Add_dependency build libXScrnSaver-devel
Add_dependency build gtk+-devel
Add_dependency build libevent-devel
Add_dependency build icu-devel
Add_dependency build nss-devel
Add_dependency build libxslt-devel
Add_dependency build alsa-lib-devel
Add_dependency build libflac-devel
Add_dependency build dbus-glib-devel
Add_dependency build libXdamage-devel
Add_dependency build libXtst-devel
Add_dependency build pam-devel
Add_dependency build libgnome-keyring-devel
Add_dependency build libvpx-devel
Add_dependency build speex-devel
Add_dependency build libwebp-devel
Add_dependency build pulseaudio-devel

wrksrc=chromium-$version

do_configure()
{
	# We need to disable system_ssl until "next protocol negotiation" support is
	# available in our nss package.
	# (See https://bugzilla.mozilla.org/show_bug.cgi?id=547312)
	#
	# XXX: Disable CUPS until a package exists.
	build/gyp_chromium --depth=. -fmake build/all.gyp \
		-Dwerror= \
		-Dlinux_sandbox_path=/usr/lib/chromium/chromium-sandbox \
		-Dffmpeg_branding=Chrome \
		-Dproprietary_codecs=1 \
		-Duse_system_libjpeg=1 \
		-Duse_system_libxslt=1 \
		-Duse_system_libxml=1 \
		-Duse_system_bzip2=1 \
		-Duse_system_zlib=1 \
		-Duse_system_libpng=1 \
		-Duse_system_ffmpeg=0 \
		-Duse_system_yasm=1 \
		-Duse_system_libevent=1 \
		-Duse_system_ssl=0 \
		-Duse_system_flac=1 \
		-Duse_system_icu=1 \
		-Duse_system_xdg_utils=1 \
		-Duse_system_vpx=1 \
		-Duse_system_speex=1 \
		-Duse_system_libwebp=1 \
		-Duse_gconf=0 \
		-Duse_cups=0 \
		-Ddisable_nacl=1
}

do_build()
{
	make BUILDTYPE=Release ${makejobs} chrome chrome_sandbox
}

do_install()
{
	vinstall out/Release/chrome 755 usr/lib/${__pkgname} ${__pkgname}
	vinstall out/Release/chrome_sandbox 4755 usr/lib/${__pkgname} ${__pkgname}-sandbox
	vinstall out/Release/chrome.pak 644 usr/lib/${__pkgname}
	vinstall out/Release/resources.pak 644 usr/lib/${__pkgname}
	vinstall out/Release/libffmpegsumo.so 755 usr/lib/${__pkgname}
	#vinstall out/Release/libppGoogleNaClPluginChrome.so 755 usr/lib/${__pkgname}
	#vcopy "out/Release/nacl_irt_x86_*.nexe" usr/lib/${__pkgname}

	for f in locales resources; do
		vcopy out/Release/${f} usr/lib/chromium
	done
	find ${DESTDIR}/usr/lib/chromium/ -name '*.d' -type f -delete
	vinstall out/Release/chrome.1 644 usr/share/man/man1 chromium.1
	vinstall ${FILESDIR}/chromium.desktop 644 usr/share/applications
	for size in 16 22 24 32 48 64 128 256; do
		install -Dm644 "chrome/app/theme/chromium/product_logo_${size}.png" \
		${DESTDIR}/usr/share/icons/hicolor/${size}x${size}/apps/chromium.png
	done
	vinstall ${FILESDIR}/chromium.sh 755 usr/bin chromium
	vinstall LICENSE 644 usr/share/licenses/${__pkgname}
}
