# Template file for 'opensmtpd'
#
# The 5.3.3p1.tar.gz is incomplete and autogenerated files are missing.
_distver=201311201707p1

pkgname=opensmtpd
version=5.3.3p1
revision=1
wrksrc="${pkgname}-${_distver}"
build_style=gnu-configure
configure_args="--sysconfdir=/etc/smtpd --sbindir=/usr/bin
 --with-maildir=/var/spool/mail --with-privsep-path=/var/db
 --with-sock-dir=/run --with-mantype=doc
 --with-privsep-user=smtpd --with-queue-user=smtpq"
hostmakedepends="pkg-config bison"
makedepends="zlib-devel openssl-devel libevent-devel db-devel"
short_desc="Free implementation of the server-side SMTP protocol"
maintainer="Juan RP <xtraeme@gmail.com>"
license="BSD, ISC, MIT"
homepage="http://www.opensmtpd.org"
distfiles="http://www.opensmtpd.org/archives/${pkgname}-${_distver}.tar.gz"
checksum=2be1ff6e7334565ac6a4b2eebd98d6cf80c1917d7293c9208c75c43f6cb85689

pre_configure() {
	# XXX hardcode the libevent major version for now.
	# XXX the configure test needs to execute a binary to
	# XXX get this result.
	sed -e 's,^\(libevent_major_version\)=.*$,\1=2,' -i configure
}

post_install() {
	vinstall LICENSE 644 usr/share/licenses/${pkgname}
	vinstall ${FILESDIR}/smtpd.service 644 usr/lib/systemd/system
	vinstall ${FILESDIR}/smtpd.socket 644 usr/lib/systemd/system
	vinstall /dev/null 644 etc/smtpd aliases
}

opensmtpd_package() {
	conf_files="/etc/smtpd/smtpd.conf /etc/smtpd/aliases"
	system_accounts="smtpd smtpq"
	systemd_services="smtpd.socket on"
	smtpq_homedir="/var/spool/mail"
	provides="smtp-forwarder-0_1 smtp-server-0_1"
	replaces="smtp-forwarder>=0 smtp-server>=0"
	pkg_install() {
		vmove all
	}
}
