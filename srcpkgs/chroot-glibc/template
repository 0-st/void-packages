# Template file for 'chroot-glibc'
pkgname=chroot-glibc
_majorver=2.17
version=${_majorver}
wrksrc="glibc-${version}"
revision=5
short_desc="The GNU C library -- for xbps-src use"
maintainer="Juan RP <xtraeme@gmail.com>"
homepage="http://www.gnu.org/software/libc"
license="GPL-2, LGPL-2.1, BSD"
distfiles="http://ftp.gnu.org/gnu/glibc/glibc-${version}.tar.xz"
checksum=6914e337401e0e0ade23694e1b2c52a5f09e4eda3270c67e7c3ba93a89b5b23e

bootstrap=yes

if [ "$IN_CHROOT" ]; then
	hostmakedepends="bison perl"
fi

do_configure() {
	[ ! -d build ] && mkdir build
	cd build

	echo "slibdir=/usr/lib" > configparms
	echo "bindir=/usr/bin" >> configparms
	echo "sbindir=/usr/sbin" >> configparms

	# Build with -mno-tls-direct-seg-refs to avoid performance problems
	# with Xen on x86 32bit.
	if [ "${XBPS_TARGET_MACHINE}" = "i686" ]; then
		export CFLAGS="$CFLAGS -mno-tls-direct-seg-refs"
        elif [ "$XBPS_TARGET_MACHINE" = "armv6l" ]; then
		# Force hard float ABI.
		# To build for soft float: --with-float=soft --without-fp.
		_floatabi="--with-float=hard"
	fi
	if [ "$CROSS_BUILD" ]; then
		_headers="--with-headers=/usr/$XBPS_CROSS_TRIPLET/include"
	else
		_headers="--with-headers=/usr/include"
	fi

	SHELL=/bin/bash ../configure ${CONFIGURE_SHARED_ARGS} \
		--enable-add-ons=ports,nptl,libidn \
		--enable-multi-arch --enable-obsolete-rpc \
		--enable-bind-now --enable-kernel=2.6.27 \
		--enable-stack-guard-randomization --disable-profile \
		--without-cvs --without-gd --libexecdir=/usr/lib \
		--libdir=/usr/lib --disable-build-nscd --disable-nscd \
		${_floatabi} ${_headers}
}

do_build() {
	cd build && make ${makejobs}
}

do_install() {
	# Create DESTDIR/etc/ld.so.conf
	mkdir -p ${DESTDIR}/etc
	echo "include /etc/ld.so.conf.d/*.conf" > ${DESTDIR}/etc/ld.so.conf

	cd ${wrksrc}/build
	make SHELL=/bin/bash install_root=${DESTDIR} install

	# ldd is a bash script, so make it run as such.
	. $XBPS_HELPERSDIR/replace-interpreter.sh
	replace_interpreter bash ${DESTDIR}/usr/bin/ldd

	# On x86_64, add dynamic linker's 32bit version to ldd.
	if [ "$XBPS_TARGET_MACHINE" = "x86_64" ]; then
		rtldlist="/lib/ld-linux.so.2 /lib/ld-linux-x86-64.so.2"
		sed -i "s|^RTLDLIST.*$|RTLDLIST=\"$rtldlist\"|" \
			${DESTDIR}/usr/bin/ldd
	fi
	vmkdir etc/ld.so.conf.d
	echo "/usr/local/lib" > ${DESTDIR}/etc/ld.so.conf.d/usr_local.conf
	chmod 644 ${DESTDIR}/etc/ld.so.conf.d/usr_local.conf
	rm -f ${DESTDIR}/etc/ld.so.cache

	# Remove unused stuff.
	rm -rf ${DESTDIR}/usr/share

	# Switch to /usr.
	vmkdir usr/sbin
	vmove "sbin/*" usr/sbin

	# Create ld-linux.so.3 symlink for ARM.
	if [ "$XBPS_TARGET_MACHINE" = "armv6l" ]; then
		ln -sfr ${DESTDIR}/usr/lib/ld-linux-armhf.so.3 \
			${DESTDIR}/usr/lib/ld-linux.so.3
	fi

	# Remove unused stuff.
	rm -rf ${DESTDIR}/var
}

chroot-glibc_package() {
	# Do not strip these files (objcopy errors out).
	nostrip_files="
		XBS5_ILP32_OFFBIG
		XBS5_ILP32_OFF32
		POSIX_V6_ILP32_OFF32
		POSIX_V6_ILP32_OFFBIG
		POSIX_V7_ILP32_OFF32
		POSIX_V7_ILP32_OFFBIG
		POSIX_V6_LP64_OFF64
		POSIX_V7_LP64_OFF64
		XBS5_LP64_OFF64"
	provides="glibc-${version} glibc-devel-${version}"
	conflicts="glibc>=0 glibc-devel>=0"
	noverifyrdeps=yes
	pkg_install() {
		vmove usr
	}
}
