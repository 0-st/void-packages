# Template file for 'hplip'
pkgname=hplip
version=3.13.11
revision=1
short_desc="HP Linux Imaging and Printing"
maintainer="davehome <davehome@redthumb.info.tm>"
homepage="http://hplipopensource.com/"
license="GPL-2"
distfiles="$SOURCEFORGE_SITE/$pkgname/$pkgname-$version.tar.gz"
checksum=1ea0ed020ab54e08620fe6ea7c30e93dbb8be505f2e6994e7222a7be63ca3b34

#XXX: pyqt pkgs for python gui
hostmakedepends="pkg-config automake libtool"
makedepends="python-devel libxml2-python cups-devel
 sane-devel ghostscript-devel net-snmp-devel libusb-devel libjpeg-turbo-devel
 dbus-devel polkit-devel foomatic-db foomatic-db-engine desktop-file-utils"

do_configure() {
	# https://bugs.archlinux.org/task/30085 - hack found in Gentoo
	# Use system foomatic-rip for hpijs driver instead of foomatic-rip-hplip
	# The hpcups driver does not use foomatic-rip
	local i
	for i in ppd/hpijs/*.ppd.gz ; do
		rm -f ${i}.temp
		gunzip -c ${i} | sed 's/foomatic-rip-hplip/foomatic-rip/g' | gzip > ${i}.temp
		mv ${i}.temp ${i}
	done

	./configure ${configure_args} --disable-gui-build \
		--disable-foomatic-rip-hplip-install \
		--enable-foomatic-ppd-install \
		--enable-hpcups-install \
		--enable-new-hpcups \
		--enable-cups-ppd-install \
		--enable-cups-drv-install \
		--enable-hpijs-install \
		--enable-foomatic-drv-install \
		--enable-pp-build \
		--enable-udev-acl-rules
}

do_build() {
	make ${makejobs}
}

do_install() {
	make rulesdir=/usr/lib/udev/rules.d DESTDIR=${DESTDIR} install
	# remove config provided by sane and autostart of hp-daemon
	rm -rf ${DESTDIR}/etc/{sane.d,xdg}
	# remove HAL .fdi file because HAL is no longer used
	rm -rf ${DESTDIR}/usr/share/hal
	rm -rf ${DESTDIR}/var
}

hplip_package() {
	depends="python foomatic-db foomatic-db-engine desktop-file-utils"
	conf_files="/etc/hp/hplip.conf"
	make_dirs="/var/lib/hp 0755 root root"
	pkg_install() {
		vmove all
	}
}
