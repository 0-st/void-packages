# Template file for 'openssl'
pkgname=openssl
_openssl_version=1.0.1
version=${_openssl_version}c
revision=1
fulldepends="perl"
crossmakedepends="zlib-devel"
conf_files="/etc/ssl/openssl.cnf"
subpackages="libssl openssl-devel"
short_desc="Secure Socket Layer and cryptographic library - runtime utilities"
maintainer="Juan RP <xtraeme@gmail.com>"
license="BSD"
homepage="http://www.openssl.org/"
distfiles="https://www.openssl.org/source/$pkgname-$version.tar.gz"
checksum=2a9eb3cd4e8b114eb9179c0d3884d61658e7d8e8bf4984798a5f5bd48e325ebe
long_desc="
 The OpenSSL Project is a collaborative effort to develop a robust,
 commercial-grade, full-featured, and Open Source toolkit implementing the
 Secure Sockets Layer (SSL v2/v3) and Transport Layer Security (TLS v1)
 protocols as well as a full-strength general purpose cryptography library."

make_dirs="
/etc/ssl/certs 0755 root root
/etc/ssl/private 0750 root root"

do_configure() {
	local _opts

	if [ "${XBPS_MACHINE}" = "x86_64" ]; then
		_target="linux-x86_64"
		_opts="enable-ec_nistp_64_gcc_128"
	elif [ "${XBPS_MACHINE}" = "i686" ]; then
		_target="linux-elf"
	elif [ "${XBPS_MACHINE}" = "armv6l" ]; then
		_target="linux-armv4"
	fi

	./Configure --prefix=/usr --openssldir=/etc/ssl --libdir=lib \
		shared zlib enable-md2 threads ${_opts} \
		${_target} -Wa,--noexecstack \
		"${CFLAGS}" -DOPENSSL_NO_TLS1_2_CLIENT
}

do_build() {
	make
}

do_install() {
	local _sover="1.0.0"

	make INSTALL_PREFIX=${DESTDIR} MANDIR=/usr/share/man install

	chmod 755 ${DESTDIR}/usr/lib/engines/*.so
	for _solib_ in libssl.so libcrypto.so; do
		chmod 755 ${DESTDIR}/usr/lib/${_solib_}.${_sover}
		cd ${DESTDIR}/usr/lib && \
			ln -sf ${_solib_}.${_sover} ${_solib_}.1 && \
			ln -sf ${_solib_}.${_sover} ${_solib_}
	done
}
