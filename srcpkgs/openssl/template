# Template file for 'openssl'
pkgname=openssl
_openssl_version=1.0.1
version=${_openssl_version}d
revision=3
fulldepends="perl"
crossmakedepends="zlib-devel"
conf_files="/etc/ssl/openssl.cnf"
subpackages="libssl openssl-devel"
short_desc="Secure Socket Layer and cryptographic library - runtime utilities"
maintainer="Juan RP <xtraeme@gmail.com>"
license="BSD"
homepage="http://www.openssl.org/"
distfiles="https://www.openssl.org/source/$pkgname-$version.tar.gz"
checksum=88a423f9b08a994054583691b968815875580e12df754e881d7cfe9f1bd1f49d

make_dirs="
/etc/ssl/certs 0755 root root
/etc/ssl/private 0750 root root"

do_configure() {
	local _opts

	if [ "${XBPS_MACHINE}" = "x86_64" ]; then
		_target="linux-x86_64"
		_opts="enable-ec_nistp_64_gcc_128"
	elif [ "${XBPS_MACHINE}" = "i686" ]; then
		_target="linux-elf"
	elif [ "${XBPS_MACHINE}" = "armv6l" ]; then
		_target="linux-armv4"
	fi

	./Configure --prefix=/usr --openssldir=/etc/ssl --libdir=lib \
		shared zlib enable-md2 threads ${_opts} \
		${_target} -Wa,--noexecstack "${CFLAGS}"
}

do_build() {
	make
}

do_install() {
	local _sover="1.0.0"

	make INSTALL_PREFIX=${DESTDIR} MANDIR=/usr/share/man install

	chmod 755 ${DESTDIR}/usr/lib/engines/*.so
	for _solib_ in libssl.so libcrypto.so; do
		chmod 755 ${DESTDIR}/usr/lib/${_solib_}.${_sover}
		cd ${DESTDIR}/usr/lib && \
			ln -sf ${_solib_}.${_sover} ${_solib_}.1 && \
			ln -sf ${_solib_}.${_sover} ${_solib_}
	done
}
