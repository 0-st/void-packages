# Template file for 'gdm'
pkgname=gdm
version=3.0.4
revision=1
distfiles="${GNOME_SITE}/$pkgname/3.0/$pkgname-$version.tar.bz2"
build_style=gnu_configure
configure_args="--disable-schemas-install --disable-scrollkeeper
--with-gconf-schema-file-dir=/usr/share/gconf/schemas --localstatedir=/var"
short_desc="GNOME Display Manager"
maintainer="Juan RP <xtraeme@gmail.com>"
homepage="http://www.gnome.org"
license="GPL-2"
checksum=60c45428ee6d4cc67c0a780a333fac621a923a6f744507e52bf409947a533087
long_desc="
 GDM is the GNOME Display Manager, it is the little proggie that runs
 in the background, runs your X sessions, presents you with a login box
 and then tells you to piss off because you forgot your password. It
 does pretty much everything that you would want to use xdm for, but
 does not involve as much crack. It doesn't use any code from xdm, and
 has a more paranoid and safer design overall. It also includes many
 features over xdm, the biggest one of which is that it is more user
 friendly, even if your X setup is failing. The goal is that users
 should never, ever have to use the command line to customize or
 troubleshoot gdm. It of course supports xdmcp, and in fact extends
 xdmcp a little bit in places where I thought xdm was lacking (but is
 still compatible with xdm's xdmcp)."

conf_files="
/etc/gdm/custom.conf
/etc/gdm/Init/Default
/etc/gdm/PreSession/Default
/etc/gdm/PostSession/Default
/etc/pam.d/gdm
/etc/pam.d/gdm-autologin"

gconf_schemas="gdm-simple-greeter.schemas"
gtk_iconcache_dirs="/usr/share/icons/hicolor"

# Create the 'gdm' system user/group.
system_accounts="gdm"
gdm_homedir="/var/lib/gdm"
openrc_services="gdm default true"

Add_dependency run glibc
Add_dependency run glib
Add_dependency run libX11
Add_dependency run dbus-glib
Add_dependency run dbus-libs
Add_dependency run libXau
Add_dependency run pam
Add_dependency run accountsservice
Add_dependency run gtk+3
Add_dependency run gdk-pixbuf
Add_dependency run cairo
Add_dependency run pango
Add_dependency run GConf
Add_dependency run fontconfig
Add_dependency run upower
Add_dependency run libXdmcp
Add_dependency run tcp_wrappers-libs
Add_dependency run libcanberra
Add_dependency run libXrandr
Add_dependency run libxklavier

Add_dependency build pkg-config
Add_dependency build intltool
Add_dependency build gnome-doc-utils
Add_dependency build dbus-glib-devel
Add_dependency build pam-devel
Add_dependency build accountsservice-devel
Add_dependency build gtk+3-devel
Add_dependency build GConf-devel
Add_dependency build upower-devel
Add_dependency build tcp_wrappers-devel
Add_dependency build libcanberra-devel
Add_dependency build libXrandr-devel
Add_dependency build libxklavier-devel

Add_dependency full ConsoleKit-x11
Add_dependency full xorg-server
Add_dependency full hicolor-icon-theme
Add_dependency full polkit-gnome

pre_configure()
{
	# Transform ${exec_prefix} to start at-spi-registryd!
	# Make it use at-spi2-registryd, at-spi-registryd is from gnome2.
	sed -i -e "s|\${exec_prefix}|/usr|" \
		-e "s|at-spi-registryd|at-spi2-registryd|g" \
		data/greeter-autostart/at-spi-registryd-wrapper.desktop.in.in
	sed -i -e "s|at-spi-registryd|at-spi2-registryd|g" \
		gui/simple-chooser/gdm-host-chooser.c \
		gui/simple-chooser/chooser-main.c
}

post_install()
{
	# Use our own pam files.
	rm -f ${DESTDIR}/etc/pam.d/*
	install -m644 ${FILESDIR}/gdm.pam ${DESTDIR}/etc/pam.d/gdm
	install -m644 ${FILESDIR}/gdm-autologin.pam \
		${DESTDIR}/etc/pam.d/gdm-autologin
	# Install OpenRC service.
	install -Dm755 ${FILESDIR}/gdm.rc ${DESTDIR}/etc/init.d/gdm

	mv ${DESTDIR}/usr/share/gconf/schemas/*.schemas ${wrksrc}
	gconf-merge-schema ${DESTDIR}/usr/share/gconf/schemas/${gconf_schemas} \
		--domain ${pkgname} ${wrksrc}/*.schemas
}
