# Template file for 'gpsd'
pkgname=gpsd
version=3.15
revision=1
build_style=scons
patch_args=-p1
make_build_args="dbus_export=0 gpsd_user=gpsd gpsd_group=gpsd sbindir=/usr/bin udevdir=/usr/lib/udev"
make_install_args="${make_build_args}"
short_desc="A GPS/AIS receiver monitoring daemon"
maintainer="uriahheep <uriahheep@gmail.com>"
license="BSD"
homepage="http://www.catb.org/gpsd/"
distfiles="http://download-mirror.savannah.gnu.org/releases/gpsd/gpsd-${version}.tar.gz"
checksum="81c89e271ae112313e68655ab30d227bc38fe7841ffbff0f1860b12a9d7696ea"
system_groups="gpsd"
system_accounts="gpsd"
gpsd_pgroup="gpsd"

depends="virtual?ntp-daemon ncurses libusb libcap libbluetooth pps-tools"
hostmakedepends="scons pkg-config bc python libxslt xmlto asciidoc"
makedepends="libudev-devel ntp libusb-devel python-devel pygtk-devel ncurses-devel pps-tools-devel libcap-devel libbluetooth-devel"

case "$XBPS_TARGET_MACHINE" in
	*-musl) :;;
	*) hostmakedepends+=" qt-devel" ;;
esac

pre_build() {
	unset CPPFLAGS
}

pre_install() {
	export DESTDIR=${DESTDIR}
}

do_install() {
	scons ${makejobs} CC=$CC CXX=$CXX CCFLAGS="$CFLAGS" \
		CXXFLAGS="$CXXFLAGS" LINKFLAGS="$LDFLAGS" \
		prefix=/usr destdir=${DESTDIR} DESTDIR=${DESTDIR} \
		${make_install_args} udev-install
}

gpsd-python_package() {
	short_desc+=" - python tools/bindings"
	depends="python gnuplot ${sourcepkg}>=${version}_${revision}"
	pycompile_module="gpsd"
	pkg_install() {
		vmove usr/lib/python2.7
		vmove usr/bin/gegps
		vmove usr/bin/gpscat
		vmove usr/bin/gpsfake
		vmove usr/bin/gpsprof
		vmove usr/share/man/man1/gegps.1
		vmove usr/share/man/man1/gpscat.1
		vmove usr/share/man/man1/gpsfake.1
		vmove usr/share/man/man1/gpsprof.1
	}
}

gpsd-xgps_package() {
	short_desc+=" - PyGTK based clients"
	depends="pygtk ${sourcepkg}-python>=${version}_${revision}"
	pkg_install() {
		vmove usr/bin/xgps
		vmove usr/bin/xgpsspeed
		vmove usr/share/man/man1/xgps*
	}
}

gpsd-qt_package() {
	short_desc+=" - Qt bindings"
	depends="qt ${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		case "$XBPS_TARGET_MACHINE" in
			*-musl) :;;
			arm*) :;;
			*)
				vmove usr/lib/libQgpsmm.so.* ;;
		esac
	}
}

gpsd-qt-devel_package() {
	short_desc+=" - Qt development files"
	depends="qt-devel ${sourcepkg}-devel>=${version}_${revision}"
	pkg_install() {
		case "$XBPS_TARGET_MACHINE" in
			*-musl) :;;
			*)
				vmove usr/lib/pkgconfig/Qgpsmm.pc
				vmove usr/lib/libQgpsmm.prl
				vmove usr/share/man/man3/libQgpsmm.3 ;;
		esac
	}
}

gpsd-devel_package() {
	short_desc+=" - development files"
	depends="${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		vmove usr/include
		vmove usr/lib/pkgconfig
		vmove usr/lib/*.so
	}
}
