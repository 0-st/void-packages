#!/bin/sh
#
# Registers or unregisters OpenRC services into the specified
# runlevel. This works by specifying three arguments as follows:
#
# service_name		runlevel	register
# --------------------------------------------------
# dbus			default		boolean
# --------------------------------------------------
#
# Arguments:	$ACTION = [run/targets]
#		$TARGET	= [post-install/pre-remove]
#		$PKGNAME
#		$VERSION
#		$UPDATE = [yes/no]
#
ACTION="$1"
TARGET="$2"
PKGNAME="$3"
VERSION="$4"
UPDATE="$5"

initdir=etc/init.d
metadatadir=var/db/xbps/metadata/${PKGNAME}

case "$ACTION" in
targets)
	echo "post-install pre-remove"
	;;
run)
	[ ! -x sbin/rc-update ] && exit 0
	[ ! -x sbin/rc-service ] && exit 0
	[ -z "$openrc_services" ] && exit 1

	if [ "$TARGET" = "pre-remove" ]; then
		rcupdate_args="del"
	elif [ "$TARGET" = "post-install" ]; then
		rcupdate_args="add"
	else
		exit 1
	fi

	[ ! -f etc/fstab ] && touch etc/fstab

	set -- ${openrc_services}
	while [ $# -gt 0 ]; do
		unset skip_service
		if [ "$TARGET" = "post-install" ]; then
			# The service shouldn't be registered, so just show a message
			# explaining how to add it in the future.
			case "$3" in
			[Ff][Aa][Ll][Ss][Ee]|[Oo][Ff]|0)
				skip_service=1
				;;
			[Tt][Rr][Uu][Ee]|[Oo][Nn]|1)
				unset skip_service
				;;
			esac
			if [ -n "$skip_service" ]; then
				cat <<_EOF
=========================================================================

The system service '${1}' from ${PKGNAME}-${VERSION} won't be added
into the runlevel '${2}' by default, so it will remain disabled at boot.

To start it at boot time, use the following command:

	$ rc-update add ${1} ${2}

To disable it again use:

	$ rc-update del ${1} ${2}

=========================================================================
_EOF
				shift; shift; shift;
				continue
			fi
			# Register service.
			if [ "$UPDATE" = "no" ]; then
				sbin/rc-update add ${1} ${2}
				echo "Registering '${1}' from ${PKGNAME} service to start at boot."
			fi
		else
			$initdir/$1 -q status
			rv=$?

			if [ "$UPDATE" = "no" ]; then
				#
				# If the service is running inform the user that it should be
				# stopped and unregistered manually.
				#
				if [ $rv -eq 0 ]; then
					echo "Service ${1} from ${PKGNAME} needs to be stopped!"
					echo "Please stop the service with '$initdir/$1 stop' and unregister"
					echo "the service with 'rc-update del ${1} ${2}' manually."
				else
					# Unregister the service.
					sbin/rc-update del ${1} ${2}
				fi
			else
				if [ $rv -eq 0 ]; then
					echo "Service '${1}' from ${PKGNAME} should be restarted!"
				fi
			fi
		fi
		shift; shift; shift;
	done
	;;
*)
	exit 1
	;;
esac

exit 0
