# Template file for 'lvm2'
pkgname=lvm2
version=2.02.98
revision=3
wrksrc=LVM2.${version}
build_style=gnu-configure
configure_args="--disable-selinux --enable-readline --enable-pkgconfig
 --enable-fsadm --enable-applib --sbindir=/usr/sbin --libdir=/usr/lib
 --enable-dmeventd --enable-cmdlib --enable-udev_sync --enable-udev_rules
 --with-udevdir=/usr/lib/udev/rules.d --with-default-pid-dir=/run
 --with-systemdsystemunitdir=/usr/lib/systemd/system
 --with-default-dm-run-dir=/run --with-default-run-dir=/run/lvm
 --with-default-locking-dir=/run/lock/lvm --enable-lvmetad" 
makedepends="pkg-config readline-devel libudev-devel>=183"
subpackages="liblvm2app liblvm2app-devel device-mapper device-mapper-devel"
conf_files="/etc/lvm/lvm.conf"
short_desc="Logical Volume Manager 2 utilities"
maintainer="Juan RP <xtraeme@gmail.com>"
homepage="http://sourceware.org/lvm2/"
license="GPL-2, LGPL-2.1"
distfiles="ftp://sources.redhat.com/pub/lvm2/LVM2.${version}.tgz"
checksum=71030a58fef7e00d82ca4144334548e46aad24551a3cfbe7c3059b1bd137d864

make_dirs="
/etc/lvm/archive 0755 root root
/etc/lvm/backup 0755 root root"

if [ -n "$XBPS_CROSS_TRIPLET" ]; then
	makedepends="pkg-config"
	crossmakedepends="readline-devel libudev-devel"
	configure_args="${configure_args} ac_cv_func_malloc_0_nonnull=yes
			ac_cv_func_realloc_0_nonnull=yes"
fi

post_install() {
	vinstall ${FILESDIR}/lvm2.tmpfiles 644 usr/lib/tmpfiles.d lvm2.conf
	vinstall ${FILESDIR}/lvm-monitoring.service 644 usr/lib/systemd/system
	vinstall ${FILESDIR}/lvmetad.service 644 usr/lib/systemd/system
	vinstall ${FILESDIR}/lvmetad.socket 644 usr/lib/systemd/system
	vinstall ${FILESDIR}/lvm-on-crypt.service 644 usr/lib/systemd/system
	vmkdir usr/lib/systemd/system/sockets.target.wants
	ln -sf /usr/lib/systemd/system/lvmetad.socket \
		${DESTDIR}/usr/lib/systemd/system/sockets.target.wants/lvmetad.socket
	# enable lvmetad
	sed 's|use_lvmetad = 0|use_lvmetad = 1|' -i ${DESTDIR}/etc/lvm/lvm.conf
}
