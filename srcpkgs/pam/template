# Template file for 'pam'
pkgname=pam
version=1.1.1
revision=3
wrksrc="Linux-PAM-$version"
distfiles="${KERNEL_SITE}/libs/pam/library/Linux-PAM-$version.tar.bz2"
build_style=gnu_configure
configure_args="--disable-selinux --libdir=/lib --disable-rpath
 --docdir=/usr/share/doc/pam --enable-read-both-confs
 DESTDIR=$XBPS_DESTDIR/$pkgname-$version"
short_desc="A flexible mechanism for authenticating users"
maintainer="Juan RP <xtraeme@gmail.com>"
checksum=608d3eb9d7a5e1a7505fff62e6a583fdb6e52dc05bf54dc9661c5f395b1fb904
long_desc="
 Linux-PAM provides a flexible mechanism for authenticating users.
 PAM was invented by SUN Microsystems."

conf_files="
/etc/environment
/etc/security/access.conf
/etc/security/group.conf
/etc/security/limits.conf
/etc/security/namespace.conf
/etc/security/pam_env.conf
/etc/security/time.conf"
subpackages="pam-devel pam-userdb"

Add_dependency run glibc
Add_dependency run cracklib
Add_dependency build flex
Add_dependency build gettext
Add_dependency build cracklib-devel
Add_dependency build db-devel

post_install()
{
	rm -rf ${DESTDIR}/var
	# Fix unix_chkpwd perms.
	chmod 4755 ${DESTDIR}/sbin/unix_chkpwd

	#
	# Enable by default pam_namespace(8) to mount /tmp and
	# /var/tmp as tmpfs for all users except root.
	#
	cat >> ${DESTDIR}/etc/security/namespace.conf << _EOF
#
# ------ END OF DEFAULT FILE ---------
#
# XBPS: by default create /tmp and /var/tmp tmpfs instances to
# all users except root.
#
/tmp		/tmp/.tmp_inst/		tmpfs	root
/var/tmp	/var/tmp/.tmp_inst/	tmpfs	root
#
_EOF
	chmod 644 ${DESTDIR}/etc/security/namespace.conf || return 1

	#
	# Fix a syntax error in namespace.init, -p flag is unknown
	# at least to dash and bash.
	#
	sed -i -e "s|^#!/bin/sh -p$|#!/bin/sh|" \
		${DESTDIR}/etc/security/namespace.init || return 1
	chmod 755 ${DESTDIR}/etc/security/namespace.init || return 1
}
