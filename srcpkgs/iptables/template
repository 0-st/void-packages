# Template file for 'iptables'
pkgname=iptables
version=1.4.11
revision=1
distfiles="http://www.iptables.org/projects/iptables/files/$pkgname-$version.tar.bz2"
build_style=custom-install
short_desc="Linux IPv[46] packet filtering ruleset"
maintainer="Juan RP <xtraeme@gmail.com>"
homepage="http://www.netfilter.org/"
license="GPL-2"
checksum=c436df01657b30fe1ee7bb14324e5250adefaaaad8fde5760f95f3db55ae4618
long_desc="
 iptables is the userspace command line program used to configure the Linux
 2.4.x and 2.6.x IPv4 packet filtering ruleset. It is targeted towards system
 administrators.

 Since Network Address Translation is also configured from the packet filter
 ruleset, iptables is used for this, too.

 The iptables package also includes ip6tables. ip6tables is used for
 configuring the IPv6 packet filter."

keep_empty_dirs=yes
openrc_services="iptables default false"
conf_files="
/etc/conf.d/iptables
/etc/conf.d/ip6tables"

subpackages="$pkgname-devel"

Add_dependency run glibc
Add_dependency build sed
Add_dependency build kernel-headers

do_build()
{
	sed -i '87 i libxt_RATEEST.so: libxt_RATEEST.oo' \
		extensions/GNUmakefile.in
	sed -i '88 i \\t${AM_VERBOSE_CCLD} ${CCLD} ${AM_LDFLAGS} -lm -shared ${LDFLAGS} -o $@ $<;\n' \
		extensions/GNUmakefile.in

	./configure ${CONFIGURE_SHARED_ARGS} --enable-devel --enable-libipq \
		--sbindir=/sbin \
		--with-kernel=/usr/src/kernel-headers-$(${XBPS_PKGDB_CMD} version kernel-headers)

	make ${makejobs}
}

do_install()
{
	make DESTDIR=${DESTDIR} install

	vinstall ${FILESDIR}/iptables.confd 644 etc/conf.d iptables
	vinstall ${FILESDIR}/ip6tables.confd 644 etc/conf.d ip6tables
	vinstall ${FILESDIR}/iptables.rc 755 etc/init.d iptables
	for f in $(${FILESDIR}/*.rules); do
		vinstall ${f} 644 etc/iptables
	done
	vmkdir var/lib/iptables

	# Override wrong symlinks from xtables_multi.
	for f in iptables iptables-restore iptables-save ip6tables \
		ip6tables-restore ip6tables-save; do
		ln -sf /sbin/xtables-multi ${DESTDIR}/sbin/${f}
	done
	ln -sf /sbin/xtables-multi ${DESTDIR}/usr/bin/iptables-xml
}
