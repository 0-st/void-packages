# Template file for 'runit'
pkgname=runit
version=2.1.2
revision=5
wrksrc="admin"
short_desc="A UNIX init scheme with service supervision"
maintainer="Juan RP <xtraeme@voidlinux.eu>"
license="BSD"
homepage="http://smarden.org/runit/"
distfiles="http://smarden.org/runit/runit-$version.tar.gz"
checksum=6fd0160cb0cf1207de4e66754b6d39750cff14bb0aa66ab49490992c0c47ba18
build_pie=yes

build_options="static"

do_build() {
  cd ${pkgname}-${version}/src

  if [ "$build_option_static" ]; then
	CFLAGS+=" -static"
	LDFLAGS+=" -static"
  fi

  sed -e 's,sbin/runit,usr/bin/runit,g' -i runit.h

  echo "$CC -D_GNU_SOURCE $CFLAGS" >conf-cc
  echo "$CC $LDFLAGS -Wl,-z -Wl,noexecstack" >conf-ld
  # set default service path to /var/service
  sed -i -e 's:^char \*varservice ="/service/";$:char \*varservice ="/var/service/";:' sv.c

  make ${makejobs}
}

do_install() {
  cd ${pkgname}-${version}/src

  # default services
  vmkdir var
  ln -s ../run/runit/runsvdir/current ${DESTDIR}/var/service

  vmkdir usr/bin
  install -m0755 {chpst,runit,runit-init,runsv,runsvchdir,runsvdir,sv,svlogd,utmpset} ${DESTDIR}/usr/bin

  cd ..
  vmkdir usr/share/man/man8
  install -m0644 man/* ${DESTDIR}/usr/share/man/man8

  vinstall ${FILESDIR}/_sv 644 usr/share/zsh/site-functions
}
