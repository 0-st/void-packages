# Template file for 'xen'
pkgname=xen
version=4.0.0
wrksrc=xen-${version}
distfiles="http://bits.xensource.com/oss-xen/release/$version/xen-$version.tar.gz"
build_style=gnu_makefile
make_build_target="DISTDIR=$XBPS_DESTDIR/$pkgname-$version xen tools"
make_install_target="install-xen install-tools"
short_desc="Xen Hypervisor and Utilities"
maintainer="Juan RP <xtraeme@gmail.com>"
checksum=ea4757d7947b64f01d6e850f34048db7e053731f626d8342b6a15dee8b871289
long_desc="
 This package provides the official Xen Hypervisor and related utilities
 for starting/stopping/accessing unprivileged domains (domUs)."

nostrip=yes
subpackages="xen-devel"
openrc_services="xend default"

conf_files="
/etc/sysconfig/xendomains
/etc/xen/xmexample.pv-grub
/etc/xen/xm-config.xml
/etc/xen/xmexample.hvm
/etc/xen/xmexample1
/etc/xen/xend-config.sxp
/etc/xen/qemu-ifup
/etc/xen/xmexample.hvm-stubdom
/etc/xen/xend-pci-quirks.sxp
/etc/xen/xmexample.vti
/etc/xen/xmexample.nbd
/etc/xen/xend-pci-permissive.sxp
/etc/xen/xmexample2"

Add_dependency run glibc
Add_dependency run e2fsprogs-libs
Add_dependency run bzip2
Add_dependency run xz
Add_dependency run zlib
Add_dependency run gnutls
Add_dependency run libbluetooth
Add_dependency run pciutils
Add_dependency run SDL
Add_dependency run libX11
Add_dependency run libXext
Add_dependency run MesaLib
Add_dependency run ncurses-libs
Add_dependency run libgcrypt
Add_dependency full python
Add_dependency full iproute2
Add_dependency build e2fsprogs-devel
Add_dependency build bzip2-devel
Add_dependency build xz-devel
Add_dependency build zlib-devel
Add_dependency build gnutls-devel
Add_dependency build libbluetooth-devel
Add_dependency build pciutils-devel
Add_dependency build SDL-devel
Add_dependency build libX11-devel
Add_dependency build libXext-devel
Add_dependency build MesaLib-devel
Add_dependency build ncurses-devel
Add_dependency build libgcrypt-devel
Add_dependency build dev86
Add_dependency build acpica-utils

pre_build()
{
	install -d ${DESTDIR}
	cd ${DESTDIR} && ln -sf . install

	if [ "${xbps_machine}" = "x86_64" ]; then
		install -d ${DESTDIR}/usr/lib
		cd ${DESTDIR}/usr && ln -s lib lib64 && cd ${wrksrc}
	fi
}

post_install()
{
	# Remove upstream xend and use our own.
	rm -f ${DESTDIR}/etc/init.d/xend
	install -m755 ${FILESDIR}/xend.rc ${DESTDIR}/etc/init.d/xend
	# Remove unneeded stuff.
	rm -f ${DESTDIR}/install ${DESTDIR}/usr/lib64
}
