# Template file for 'python3.4'
pkgname=python3.4
version=3.4.1
_pybasever=3.4
revision=1
wrksrc="Python-${version}"
short_desc="Interpreted, interactive, object-oriented programming language (${version%.*} series)"
maintainer="Juan RP <xtraeme@gmail.com>"
homepage="http://www.python.org"
license="PSF"
distfiles="http://www.python.org/ftp/python/${version}/Python-${version}.tar.xz"
checksum=c595a163104399041fcbe1c5c04db4c1da94f917b82ce89e8944c8edff7aedc4

makedepends="libffi-devel readline-devel>=6.3 gdbm-devel openssl-devel
 expat-devel sqlite-devel bzip2-devel zlib-devel liblzma-devel"

pre_configure() {
	sed -i -e "s|^#.* /usr/local/bin/python|#!/usr/bin/python3|" Lib/cgi.py
	# Ensure that internal copies of zlib, expat and libffi are not used
	rm -r Modules/zlib
	rm -r Modules/expat
	rm -r Modules/_ctypes/{darwin,libffi}*
}

if [ "$CROSS_BUILD" ]; then
	msg_red "${pkgname}-${version} cannot be cross compiled right now.\n"
	exit 0
fi

# Native build
do_configure() {
	unset LD CC AR AS RANLIB

	./configure ${configure_args} --with-threads --enable-ipv6 \
		--with-signal-module --enable-shared --with-system-ffi \
		--with-computed-gotos --with-system-expat \
		--with-dbmliborder=gdbm:ndbm --without-ensurepip \
		ac_cv_posix_semaphores_enabled=yes
}

do_build() {
	make ${makejobs}
}

do_install() {
	make DESTDIR=${DESTDIR} install maninstall
	install -Dm644 LICENSE ${DESTDIR}/usr/share/licenses/${pkgname}/LICENSE

	rm -f ${DESTDIR}/usr/bin/2to3{,-3.4}

	ln -sf ../../libpython${_pybasever}m.so \
		${DESTDIR}/usr/lib/python${_pybasever}/config-${_pybasever}m/libpython${_pybasever}m.so
}

python3.4-devel_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove "usr/bin/python*-config"
		vmove usr/lib/pkgconfig
		vmove usr/include
		mkdir -p ${DESTDIR}/usr/include/python${_pybasever}m
		mv ${PKGDESTDIR}/usr/include/python${_pybasever}m/pyconfig.h \
			${DESTDIR}/usr/include/python${_pybasever}m
	}
}
