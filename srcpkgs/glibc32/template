# Template file for 'glibc32'
pkgname=glibc32
version=2.16.0
revision=6
distfiles="
http://xbps.nopcode.org/repos/current/glibc32-2.16.0_6.x86_64.xbps
http://xbps.nopcode.org/repos/current/glibc32-devel-2.16.0_6.x86_64.xbps"
depends="glibc>=$version"
makedepends="bsdtar"
short_desc="The GNU C library (32 bits)"
homepage="http://www.gnu.org/software/libc"
license="GPL-2, LGPL-2.1, BSD"
maintainer="Juan RP <xtraeme@gmail.com>"
checksum="
a63a2d98b0f043d31713e538916e3c1a5cdf7b3bbab7d99054a4bb895cf43159
72f6c2b475f77c38f46aaf6042f44c55e51fb1f3a1447cb7837590d69017ec42"
long_desc="
 The GNU C Library is the standard system C library for all GNU systems,
 and is an important part of what makes up a GNU system.  It provides the
 system API for all programs written in C and C-compatible languages such
 as C++ and Objective C; the runtime facilities of other programming
 languages use the C library to access the underlying operating system.

 This package installs the 32 bit libraries for x86_64 systems."

subpackages="${pkgname}-devel"
nostrip=yes
noextract=yes
noverifyrdeps=yes
only_for_archs=x86_64

do_install() {
	for f in ${distfiles}; do
		local srcfile="${XBPS_SRCDISTDIR}/$(basename ${f})"
		bsdtar xf ${srcfile} -C ${wrksrc}
	done

	vinstall usr/include/gnu/stubs-32.h 644 usr/include/gnu
	vmkdir usr/lib
        vmkdir usr/lib32/gconv
        cd ${wrksrc}

	install -m644 usr/lib32/*.{a,o} ${DESTDIR}/usr/lib32
	install -m755 usr/lib32/*.so ${DESTDIR}/usr/lib32

	# Add /lib32 and /usr/lib32 into ld.so(8) cache.
	install -d ${DESTDIR}/etc/ld.so.conf.d
	echo "/usr/lib32" > ${DESTDIR}/etc/ld.so.conf.d/glibc32.conf

	chmod 644 ${DESTDIR}/etc/ld.so.conf.d/glibc32.conf && ldconfig

	# Fix some .so files to find stuff in lib32 dirs.
	for f in libc libpthread; do
		sed -i -e "s|/lib/|/lib32/|g" \
			${DESTDIR}/usr/lib32/${f}.so
	done
}
