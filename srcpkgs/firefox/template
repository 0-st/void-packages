# Template build file for 'firefox'.
pkgname=firefox
version=12.0
wrksrc=mozilla-release
distfiles="${MOZILLA_SITE}/${pkgname}/releases/${version}/source/${pkgname}-${version}.source.tar.bz2"
short_desc="Lightweight gecko-based web browser"
maintainer="Juan RP <xtraeme@gmail.com>"
homepage="http://www.mozilla.org/projects/firefox"
license="MPL-1.1, GPL-2, LGPL-2.1"
checksum=9a232a10e5803b0e4a85bd986e3e88b87ccde7bdc3363ea7022d5761944dbb1d
long_desc="
 Mozilla Firefox is a free, open-source and cross-platform web browser
 for Windows, Linux, MacOS X and many other operating systems. It is
 small, fast and easy to use, and offers many advantages over other web
 browsers, such as tabbed browsing and the ability to block pop-up
 windows.

 Firefox also offers excellent bookmark and history management, and it
 can be extended by developers using industry standards such as XML,
 CSS, JavaScript, C++, etc. Many extensions are available."

gtk_iconcache_dirs="/usr/share/icons/hicolor"

Add_dependency build unzip
Add_dependency build zip
Add_dependency build perl	">=0"
Add_dependency build python	">=2.7.2_3" # linux2 sys.platform fix
Add_dependency build yasm
Add_dependency build jpeg-devel
Add_dependency build libpng-devel
Add_dependency build pixman-devel
Add_dependency build libIDL-devel
Add_dependency build nss-devel ">=3.13.3"
Add_dependency build sqlite-devel
Add_dependency build libXrender-devel
Add_dependency build libXScrnSaver-devel
Add_dependency build gtk+-devel
Add_dependency build libevent-devel
Add_dependency build libnotify-devel
Add_dependency build libvpx-devel
Add_dependency build GConf-devel
Add_dependency build startup-notification-devel
Add_dependency build dbus-glib-devel
Add_dependency build alsa-lib-devel
Add_dependency build hunspell-devel
Add_dependency build wireless_tools-devel

Add_dependency run desktop-file-utils
Add_dependency run hicolor-icon-theme

do_build() {
	# Fix PRE_RELEASE_SUFFIX
	sed -i '/^PRE_RELEASE_SUFFIX := ""/s/ ""//' browser/base/Makefile.in
	cp -f ${FILESDIR}/mozconfig .mozconfig
	export LDFLAGS="-Wl,-R/usr/lib/firefox"
	# Fix for libvpx-1.0.0 detection.
	sed -i -e "s|VPX_CODEC_USE_INPUT_PARTITION|VPX_CODEC_USE_INPUT_FRAGMENTS|g" configure

	make ${makejobs} -f client.mk MOZ_MAKE_FLAGS="${makejobs}"
}

do_install() {
	make -f client.mk DESTDIR=${DESTDIR} install

	vinstall ${FILESDIR}/vendor.js 644 usr/lib/firefox/defaults/pref

	vinstall ${FILESDIR}/firefox.desktop 644 usr/share/applications
	for i in 16x16 22x22 24x24 32x32 48x48 256x256; do
		vinstall browser/branding/official/default${i%x*}.png 644 \
			usr/share/icons/hicolor/${i}/apps firefox.png
	done

	# We don't want the development stuff
	rm -rf ${DESTDIR}/usr/{include,lib/firefox-devel,share/idl}

	# https://bugzilla.mozilla.org/show_bug.cgi?id=658850
	ln -sf firefox ${DESTDIR}/usr/lib/firefox/firefox-bin
}
