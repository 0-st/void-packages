# Build template for 'busybox-initramfs'.
pkgname=busybox-initramfs
version=1.16.1
revision=1
wrksrc=busybox-$version
distfiles="http://www.busybox.net/downloads/busybox-$version.tar.bz2"
build_style=gnu_makefile
make_install_args="
CONFIG_PREFIX=${XBPS_DESTDIR}/${pkgname}-${version}/usr/lib/${pkgname}"
short_desc="The Swiss Army Knife of Embedded Linux for initial ramdisks"
maintainer="Juan RP <xtraeme@gmail.com>"
checksum=6d45ec8e72ca85516c8669f81267e0fbe11881435983e32532a56b44651dd6c5
long_desc="
 BusyBox combines tiny versions of many common UNIX utilities into a single
 small executable. It provides replacements for most of the utilities you
 usually find in GNU fileutils, shellutils, etc. The utilities in BusyBox
 generally have fewer options than their full-featured GNU cousins; however,
 the options that are included provide the expected functionality and behave
 very much like their GNU counterparts. BusyBox provides a fairly complete
 environment for any small or embedded system.

 This package provides some required utilities for the initial ramdisks."

base_chroot=yes
Add_dependency run glibc

pre_build()
{
	# It seems that gcc-4.5 generates a bad busybox binary,
	# notably sed(1) segfaults on every command. Download a
	# binary from busybox.net.
	if [ "${xbps_machine}" = "x86_64" ]; then
		${XBPS_FETCH_CMD} \
			http://www.busybox.net/downloads/binaries/${version}/busybox-x86_64
	fi
	cp -f ${FILESDIR}/dotconfig ${wrksrc}/.config
}

post_install()
{
	if [ "${xbps_machine}" = "x86_64" ]; then
		mv ${wrksrc}/busybox-x86_64 \
			${DESTDIR}/usr/lib/busybox-initramfs/bin/busybox
		chmod 755 ${DESTDIR}/usr/lib/busybox-initramfs/bin/busybox
	fi
	:
}
