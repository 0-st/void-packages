# Template file for 'chromium'
pkgname=chromium
version=20.0.1132.43
revision=1
wrksrc=$pkgname
create_wrksrc=yes
create_srcdir=yes
build_requires=27
build_wrksrc=${pkgname}-${version}
depends="desktop-file-utils hicolor-icon-theme"
makedepends="pkg-config which unzip yasm flex gperf perl python
libudev-devel>=138 libpng-devel>=1.5.10 libgcrypt-devel libelf-devel
mit-krb5-devel libXrender-devel libXScrnSaver-devel libXcomposite-devel
libX11-devel libXi-devel gtk+-devel libevent-devel nss-devel alsa-lib-devel
dbus-glib-devel libXdamage-devel libXtst-devel pam-devel libgnome-keyring-devel
libvpx-devel speex-devel libwebp-devel pulseaudio-devel cups-devel
hunspell-devel libflac-devel subversion"
if [ "$XBPS_MACHINE" = "x86_64" ]; then
	makedepends="${makedepends} gcc-multilib"
fi
gtk_iconcache_dirs="/usr/share/icons/hicolor"
short_desc="Google's attempt at creating a safer, faster, and more stable browser"
maintainer="Juan RP <xtraeme@gmail.com>"
homepage="http://www.chromium.org/"
license="BSD"
distfiles="
http://commondatastorage.googleapis.com/chromium-browser-official/$pkgname-$version.tar.bz2
http://commondatastorage.googleapis.com/nativeclient-mirror/nacl/nacl_sdk/$version/naclsdk_linux.bz2"
checksum="
c21bdee0ec136102e10c527a0d98e3a29e40406d8f7eb63e8e0ac23801722824
aa836ba493e659f028e8624764ba7662ef4eccd609be4c6812a7901eaf63f6e4"
long_desc="
 Chromium is an open-source browser project that aims to build a safer,
 faster, and more stable way for all Internet users to experience the web.

 Chromium serves as a base for Google Chrome, which is Chromium rebranded
 (name and logo) with very few additions such as usage tracking and an
 auto-updater system.

 This package contains the Chromium browser."

pre_configure() {
	# http://code.google.com/p/chromium/issues/detail?id=109527
	sed -i 's|glib/gutils.h|glib.h|' ui/base/l10n/l10n_util.cc

	# Unpack nacl, file is a real POSIX tar archive compressed with bzip2.
	tar xf $wrksrc/naclsdk_linux -C $wrksrc

	ln -s $wrksrc/pepper_${version%%.*}/toolchain/linux_x86_newlib \
		native_client/toolchain/linux_x86_newlib
}

do_configure() {
	build/gyp_chromium -f make build/all.gyp --depth=. \
		-Dwerror= -Dlinux_sandbox_path=/usr/lib/chromium/chromium-sandbox \
		-Drelease_extra_cflags="$CFLAGS" -Dlinux_use_gold_binary=0 \
		-Dlinux_use_gold_flags=0 -Dffmpeg_branding=Chrome \
		-Dproprietary_codecs=1 -Duse_system_libjpeg=1 \
		-Duse_system_libxml=0 -Duse_system_bzip2=1 \
		-Duse_system_zlib=1 -Duse_system_libpng=1 \
		-Duse_system_ffmpeg=0 -Duse_system_yasm=1 \
		-Duse_system_libevent=1 -Duse_system_ssl=0 \
		-Duse_system_xdg_utils=1 -Duse_system_vpx=1 \
		-Duse_system_speex=1 -Duse_system_libwebp=1 \
		-Duse_hunspell=1 -Duse_system_flac=1 -Duse_gconf=0
}

do_build() {
	make BUILDTYPE=Release ${makejobs} chrome chrome_sandbox
}

do_install() {
	vinstall out/Release/chrome 755 usr/lib/${pkgname} ${pkgname}
	vinstall out/Release/chrome_sandbox 4755 usr/lib/${pkgname} ${pkgname}-sandbox
	vinstall out/Release/chrome.pak 644 usr/lib/${pkgname}
	vinstall out/Release/resources.pak 644 usr/lib/${pkgname}
	vinstall out/Release/libffmpegsumo.so 755 usr/lib/${pkgname}
	vinstall out/Release/libppGoogleNaClPluginChrome.so 755 usr/lib/${pkgname}
	vinstall out/Release/nacl_helper 755 usr/lib/$pkgname
	vinstall out/Release/nacl_helper_bootstrap 755 usr/lib/$pkgname
	vcopy "out/Release/nacl_irt_*.nexe" usr/lib/${pkgname}

	for f in locales resources; do
		vcopy out/Release/${f} usr/lib/chromium
	done
	find ${DESTDIR}/usr/lib/chromium/ -name '*.d' -type f -delete
	vinstall out/Release/chrome.1 644 usr/share/man/man1 chromium.1
	vinstall ${FILESDIR}/chromium.desktop 644 usr/share/applications
	for size in 16 22 24 32 48 64 128 256; do
		install -Dm644 "chrome/app/theme/chromium/product_logo_${size}.png" \
		${DESTDIR}/usr/share/icons/hicolor/${size}x${size}/apps/chromium.png
	done
	vinstall ${FILESDIR}/chromium.sh 755 usr/bin chromium
	vinstall LICENSE 644 usr/share/licenses/${pkgname}
}
