# Template file for 'chromium'
#
# Disable NaCL for now, broken with glibc-2.16.
#_build_nacl=1
pkgname=chromium
version=23.0.1271.91
patch_args="-Np0"
revision=1
short_desc="Google's attempt at creating a safer, faster, and more stable browser"
maintainer="Juan RP <xtraeme@gmail.com>"
homepage="http://www.chromium.org/"
license="BSD"
_url_base="http://commondatastorage.googleapis.com"
distfiles="${_url_base}/chromium-browser-official/${pkgname}-${version}.tar.bz2"
checksum="385d1abe2800e64261cbfb6b5d91e1f4a818e0c832a581654a6b7ebd10f35b01"

if [ -n "${_build_nacl}" ]; then
 distfiles="${distfiles} ${_url_base}/nacl/nacl_sdk/${version}/naclsdk_linux.tar.bz2"
 checksum="${checksum} 85d0a9e2903a1d82b40c5e5a54350df6a5171eb1831f42e1f0e22f3a42e3ca13"
fi

long_desc="
 Chromium is an open-source browser project that aims to build a safer,
 faster, and more stable way for all Internet users to experience the web.

 Chromium serves as a base for Google Chrome, which is Chromium rebranded
 (name and logo) with very few additions such as usage tracking and an
 auto-updater system."

wrksrc=${pkgname}
create_wrksrc=yes
create_srcdir=yes
build_wrksrc=${pkgname}-${version}

depends="desktop-file-utils hicolor-icon-theme"
makedepends="pkg-config which unzip yasm bison25 flex gperf perl python
 libudev-devel>=138 libpng-devel>=1.5.10 libgcrypt-devel elfutils-devel
 mit-krb5-devel libXrender-devel libXScrnSaver-devel libXcomposite-devel
 libX11-devel libXi-devel gtk+-devel libevent-devel nss-devel alsa-lib-devel
 dbus-glib-devel libXdamage-devel libXtst-devel pam-devel libgnome-keyring-devel
 libvpx-devel speex-devel libwebp-devel>=0.2.0 pulseaudio-devel cups-devel
 hunspell-devel libflac-devel icu-devel libxslt-devel libusb-devel v8-devel
 libXrandr-devel"
if [ "$XBPS_MACHINE" = "x86_64" ]; then
 makedepends="${makedepends} gcc-multilib"
fi

pre_configure() {
	# http://code.google.com/p/chromium/issues/detail?id=109527
	sed -i 's|glib/gutils.h|glib.h|' ui/base/l10n/l10n_util.cc

	if [ -n "${_build_nacl}" ]; then
		ln -s ${wrksrc}/pepper_${version%%.*}/toolchain/linux_x86_newlib \
			native_client/toolchain/linux_x86_newlib
	fi
}

do_configure() {
	if [ -z "${_build_nacl}" ]; then
		_nacl="-Ddisable_nacl=1"
	fi

	build/gyp_chromium -f make build/all.gyp --depth=. \
		-Dwerror= \
		-Dlinux_sandbox_path=/usr/lib/chromium/chromium-sandbox \
		-Drelease_extra_cflags="$CFLAGS" \
		-Dlinux_use_gold_binary=0 \
		-Dlinux_use_gold_flags=0 \
		-Dffmpeg_branding=Chrome \
		-Dproprietary_codecs=1 \
		-Duse_system_libjpeg=1 \
		-Duse_system_bzip2=1 \
		-Duse_system_flac=1 \
		-Duse_system_icu=1  \
		-Duse_system_libevent=1 \
		-Duse_system_libjpeg=1 \
		-Duse_system_libpng=1 \
		-Duse_system_libusb=1 \
		-Duse_system_libwebp=1 \
		-Duse_system_libxml=1 \
		-Duse_system_speex=1 \
		-Duse_system_v8=1 \
		-Duse_system_xdg_utils=1 \
		-Duse_system_yasm=1 \
		-Duse_system_vpx=1 \
		-Duse_system_xdg_utils=1 \
		-Duse_system_nss=1 \
		-Duse_system_ssl=0 \
		-Duse_system_sqlite=0 \
		-Duse_gconf=0 \
		-Dlinux_use_tcmalloc=0 \
		-Dlinux_link_gsettings=1 ${_nacl}
}

do_build() {
	make BUILDTYPE=Release ${makejobs} chrome chrome_sandbox
}

do_install() {
	vinstall out/Release/chrome 755 usr/lib/${pkgname} ${pkgname}
	vinstall out/Release/chrome_sandbox 4755 usr/lib/${pkgname} ${pkgname}-sandbox

	cp out/Release/{*.pak,libffmpegsumo.so} ${DESTDIR}/usr/lib/chromium

	if [ -n "${_build_nacl}" ]; then
		cp out/Release/{nacl_helper{,_bootstrap}} \
			out/Release/{libppGoogleNaClPluginChrome.so,nacl_irt_*.nexe} \
			${DESTDIR}/usr/lib/chromium
	fi

	cp -a out/Release/locales ${DESTDIR}/usr/lib/chromium

	vinstall out/Release/chrome.1 644 usr/share/man/man1 chromium.1
	vinstall ${FILESDIR}/chromium.desktop 644 usr/share/applications

	for size in 22 24 48 64 128 256; do
		install -Dm644 "chrome/app/theme/chromium/product_logo_${size}.png" \
		${DESTDIR}/usr/share/icons/hicolor/${size}x${size}/apps/chromium.png
	done
	for size in 16 32; do
		install -Dm644 "chrome/app/theme/default_100_percent/chromium/product_logo_${size}.png" \
		${DESTDIR}/usr/share/icons/hicolor/${size}x${size}/apps/chromium.png
	done

	vinstall ${FILESDIR}/chromium.sh 755 usr/bin chromium
	vinstall LICENSE 644 usr/share/licenses/${pkgname}
}
