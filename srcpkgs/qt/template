# Template file for 'qt'
pkgname=qt
version=4.8.1
patch_args="-Np1"
_distname=qt-everywhere-opensource-src
wrksrc=${_distname}-${version}
homepage="http://qt.nokia.com/"
distfiles="ftp://ftp.qt.nokia.com/qt/source/${_distname}-$version.tar.gz"
short_desc="A cross-platform application and UI framework"
maintainer="Juan RP <xtraeme@gmail.com>"
license="GPL-3, LGPL-2.1"
checksum=ef851a36aa41b4ad7a3e4c96ca27eaed2a629a6d2fa06c20f072118caed87ae8
long_desc="
 Qt(TM) is a GUI software toolkit. Qt simplifies the task of writing and
 maintaining GUI (graphical user interface) applications."

subpackages="qt-libphonon qt-plugin-pgsql qt-plugin-mysql qt-plugin-sqlite"
subpackages="${subpackages} qt-demos qt-docs qt-qmake qt-qtconfig"
subpackages="${subpackages} qt-designer qt-devel qt-devel-tools"
subpackages="${subpackages} qt-plugin-gstreamer"

# XXX Missing dependencies: unixodbc.
Add_dependency build pkg-config
Add_dependency build freetype-devel
Add_dependency build MesaLib-devel
Add_dependency build libXrender-devel
Add_dependency build fontconfig-devel
Add_dependency build libXext-devel
Add_dependency build libX11-devel
Add_dependency build libstdc++-devel
Add_dependency build libXi-devel
Add_dependency build libXv-devel
Add_dependency build libXinerama-devel
Add_dependency build libXrandr-devel
Add_dependency build libXcursor-devel
Add_dependency build zlib-devel
Add_dependency build dbus-devel
Add_dependency build glib-devel
Add_dependency build gstreamer-devel
Add_dependency build gst-plugins-base-devel
Add_dependency build sqlite-devel
Add_dependency build alsa-lib-devel
Add_dependency build openssl-devel
Add_dependency build tiff-devel
Add_dependency build libmng-devel
Add_dependency build jpeg-devel
Add_dependency build libpng-devel
Add_dependency build libSM-devel
Add_dependency build libICE-devel
Add_dependency build libmysqlclient-devel
Add_dependency build postgresql-libs-devel
Add_dependency build pulseaudio-devel
Add_dependency build gtk+-devel
Add_dependency build icu-devel
Add_dependency build cups-devel

do_configure() {
	export LD_LIBRARY_PATH="${wrksrc}/lib:${LD_LIBRARY_PATH}"

	sed -i "s|-O2|${XBPS_CXXFLAGS}|" mkspecs/common/g++.conf
	sed -i "/^QMAKE_LFLAGS\s/s|+=|+= ${XBPS_LDFLAGS}|g" mkspecs/common/g++.conf

	./configure -v -confirm-license -opensource \
		-prefix /usr -sysconfdir /etc -plugindir /usr/lib/qt/plugins \
		-importdir /usr/lib/qt/imports \
		-translationdir /usr/share/qt/translations \
		-datadir /usr/share/qt \
		-docdir /usr/share/doc/qt \
		-examplesdir /usr/share/doc/qt/examples \
		-demosdir /usr/share/doc/qt/demos -largefile \
		-plugin-sql-sqlite -system-sqlite \
		-xmlpatterns -svg -no-webkit \
		-scripttools -system-zlib -graphicssystem raster \
		-system-libtiff -system-libpng -system-libmng -system-libjpeg \
		-openssl-linked -optimized-qmake -no-rpath -reduce-relocations \
		-no-separate-debug-info -gtkstyle -opengl -glib -gstreamer \
		-no-sql-db2 -no-sql-ibase -gtkstyle \
		-plugin-sql-mysql -plugin-sql-psql -no-sql-oci \
		-no-sql-odbc -no-sql-sqlite2 \
		-dbus-linked -no-nas-sound -iconv -shared \
		-release -fast -no-sql-tds
}

do_build() {
	make ${makejobs}
}

do_install() {
	local hicolordir=${DESTDIR}/usr/share/icons/hicolor

	make INSTALL_ROOT=${DESTDIR} install

	# delete tests
	rm -rf ${DESTDIR}/usr/tests

	# install missing icons and desktop files
	for icon in tools/linguist/linguist/images/icons/linguist-*-32.png ; do
		size=$(echo $(basename ${icon}) | cut -d- -f2)
		install -D -m644 ${icon} \
			${hicolordir}/${size}x${size}/apps/linguist.png
	done
	install -Dm644 src/gui/dialogs/images/qtlogo-64.png \
		${hicolordir}/64x64/apps/qtlogo.png
	install -Dm644 src/gui/dialogs/images/qtlogo-64.png \
		${DESTDIR}/usr/share/pixmaps/qtlogo.png
	install -Dm644 tools/assistant/tools/assistant/images/assistant.png \
		${hicolordir}/32x32/apps/assistant.png
	install -Dm644 tools/designer/src/designer/images/designer.png \
		${hicolordir}/128x128/apps/designer.png
	install -d ${DESTDIR}/usr/share/applications
	install -m644 ${FILESDIR}/*.desktop \
		${DESTDIR}/usr/share/applications
}
