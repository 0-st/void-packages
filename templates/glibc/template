# Template file for 'glibc'
pkgname=glibc
sourcepkg=glibc
version=2.9
# Uncomment these lines to use a snapshot from Redhat.
#glibc_snapdate=20090209
#wrksrc="$pkgname-$version-$glibc_snapdate"
#distfiles="ftp://sources.redhat.com/pub/glibc/snapshots/$pkgname-$version-$glibc_snapdate.tar.bz2"
distfiles="http://ftp.gnu.org/gnu/glibc/glibc-${version}.tar.gz"
build_style=gnu_configure
configure_script="../configure"
configure_args="--with-tls -disable-profile --with-__thread
 --enable-kernel=2.6.27 --enable-add-ons --without-gd
 --without-cvs --without-selinux --infodir=/usr/share/info
 --libdir=/usr/lib --libexecdir=/usr/lib --enable-stackguard-randomization
 --with-headers=$XBPS_MASTERDIR/usr/include"
make_install_target="install_root=$XBPS_DESTDIR/$pkgname-$version install"
short_desc="The GNU C library"
maintainer="Juan RP <xtraeme@gmail.com>"
checksum=e0210dec2a4ca0a03d8ee26e2a4ebccc915d99f4cdb1489ff0f9f4ce7bda3e30
long_desc="
 The GNU C Library is the standard system C library for all GNU systems,
 and is an important part of what makes up a GNU system.  It provides the
 system API for all programs written in C and C-compatible languages such
 as C++ and Objective C; the runtime facilities of other programming
 languages use the C library to access the underlying operating system."

base_chroot=yes
conf_files="/etc/rpc /etc/ld.so.conf /etc/ld.so.cache /etc/nsswitch.conf"
subpackages="devel locales"

Add_dependency build	gcc
Add_dependency build	gawk
Add_dependency build	kernel-libc-headers
Add_dependency run	xbps-base-dirs
Add_dependency run	gcc-libgcc
Add_dependency run	glibc-locales

pre_configure()
{
	# We must configure it in another directory.
	wrksrc=$wrksrc/build_obj
	mkdir -p $wrksrc
	echo "slibdir=/lib" > $wrksrc/configparms
	# glibc fails to build if -march not set for a minimal cpu.
	if [ "$xbps_machine" != "x86_64" ]; then
		echo "CFLAGS+=-march=${xbps_machine%%-*} -mtune=generic" \
			>> $wrksrc/configparms
	fi
}

pre_install()
{
	# Create destdir/etc/ld.so.conf
	mkdir -p $XBPS_DESTDIR/$pkgname-$version/etc
	echo "/usr/local/lib" > $XBPS_DESTDIR/$pkgname-$version/etc/ld.so.conf
}

post_install()
{
	local destdir=$XBPS_DESTDIR/$pkgname-$version

	# Replace hardcoded path to bash.
	. $XBPS_HELPERSDIR/replace-interpreter.sh
	replace_interpreter bash $destdir/usr/bin/ldd

	# On x86_64, add dynamic linker's 32bit version to ldd.
	if [ "$xbps_machine" = "x86_64" ]; then
		rtldlist="/lib/ld-linux.so.2 /lib/ld-linux-x86-64.so.2"
		sed -i "s|^RTLDLIST.*$|RTLDLIST=\"$rtldlist\"|" \
			$destdir/usr/bin/ldd
	fi

	# Create nsswitch.conf
	( 				\
	echo "passwd: files";		\
	echo "group: files";		\
	echo "shadow: files";		\
	echo;				\
	echo "hosts: files dns";	\
	echo "networks: files";		\
	echo;				\
	echo "protocols: files";	\
	echo "services: files";		\
	echo "ethers: files";		\
	echo "rpc: files";		\
	) > $destdir/etc/nsswitch.conf

	wrksrc=${wrksrc%%/build_obj}
}
