# Template file for 'glibc'
pkgname=glibc
sourcepkg=glibc
version=2.9
glibc_snapdate=20090209
wrksrc="$pkgname-$version-$glibc_snapdate"
distfiles="ftp://sources.redhat.com/pub/glibc/snapshots/$pkgname-$version-$glibc_snapdate.tar.bz2"
build_style=gnu_configure
configure_script="../configure"
configure_args="--with-tls -disable-profile --with-__thread
 --enable-kernel=2.6.16 --enable-add-ons --without-gd --enable-bind-now
 --without-cvs --without-selinux --infodir=/usr/share/info
 --libdir=/usr/lib --libexecdir=/usr/lib"
make_install_target="install_root=$XBPS_DESTDIR/$pkgname-$version install"
short_desc="The GNU C library"
maintainer="Juan RP <xtraeme@gmail.com>"
checksum=d5ae995e8a90ffa6ed05e213f3ce4c5c36322be551f0001cf0904fd46e040a73
long_desc="
 The GNU C Library is the standard system C library for all GNU systems,
 and is an important part of what makes up a GNU system.  It provides the
 system API for all programs written in C and C-compatible languages such
 as C++ and Objective C; the runtime facilities of other programming
 languages use the C library to access the underlying operating system."

base_chroot=yes
build_depends="gcc-4.3.2 gawk-3.1.6"
subpackages="base dev libs locale"

pre_configure()
{
	# We must configure it in another directory.
	wrksrc=$wrksrc/build_obj
	mkdir -p $wrksrc
	echo "slibdir=/lib" > $wrksrc/configparms
	# glibc fails to build if -march not set for a minimal cpu.
	if [ "$xbps_machine" != "x86_64" ]; then
		echo "CFLAGS+=-march=${xbps_machine%%-*} -mtune=generic" \
			>> $wrksrc/configparms
	fi
}

pre_install()
{
	# Create destdir/etc/ld.so.conf
	mkdir -p $XBPS_DESTDIR/$pkgname-$version/etc
	touch $XBPS_DESTDIR/$pkgname-$version/etc/ld.so.conf
}

post_install()
{
	local destdir=$XBPS_DESTDIR/$pkgname-$version

	# Replace hardcoded path to bash.
	. $XBPS_HELPERSDIR/replace-interpreter.sh
	replace_interpreter bash $destdir/usr/bin/ldd

	# On x86_64, add dynamic linker's 32bit version to ldd.
	if [ "$xbps_machine" = "x86_64" ]; then
		rtldlist="/lib/ld-linux.so.2 /lib/ld-linux-x86-64.so.2"
		sed -i "s|^RTLDLIST.*$|RTLDLIST=\"$rtldlist\"|" \
			$destdir/usr/bin/ldd
	fi

	# Create nsswitch.conf
	( 				\
	echo "passwd: files";		\
	echo "group: files";		\
	echo "shadow: files";		\
	echo;				\
	echo "hosts: files dns";	\
	echo "networks: files";		\
	echo;				\
	echo "protocols: files";	\
	echo "services: files";		\
	echo "ethers: files";		\
	echo "rpc: files";		\
	) > $destdir/etc/nsswitch.conf

	wrksrc=${wrksrc%%/build_obj}
}
