# Template file for 'klibc-module-init-tools'
pkgname=klibc-module-init-tools
version=3.8
wrksrc="module-init-tools-${version}"
distfiles="${KERNEL_SITE}/utils/kernel/module-init-tools/module-init-tools-$version.tar.bz2"
build_style=custom-install
short_desc="Tools for managing kernel modules for initramfs"
maintainer="Juan RP <xtraeme@gmail.com>"
checksum=dc880716a6b16a28dd5e18178bd266b9f598bd29b2580688390915bcc1aef65e
long_desc="
 The module-init-tools package provides many of the utilities
 needed by Linux systems for managing loadable Linux Kernel Modules. This
 includes depmod, insmod, rmmod, modprobe and tools like modinfo.

 This package uses klibc for use in the initramfs."

Add_dependency build klibc
Add_dependency run klibc

do_install()
{
	cd $wrksrc
	CFLAGS="-O2 -DCONFIG_NO_BACKWARDS_COMPAT" \
		CC=klcc LD=klcc ./configure --prefix=
	# klibc lacks getc_unlocked, so use getc instead
	sed 's|getc_unlocked|getc|g' -i *.c
	make || return 1

	install -d ${DESTDIR}/usr/lib/klibc/sbin
	for f in depmod modinfo modprobe insmod lsmod rmmod; do
		install -s -m755 build/${f} ${DESTDIR}/usr/lib/klibc/sbin
	done
}
