# Template file for 'klibc-module-init-tools'
pkgname=klibc-module-init-tools
version=3.6
wrksrc="module-init-tools-${version}"
distfiles="
http://www.kernel.org/pub/linux/utils/kernel/module-init-tools/module-init-tools-$version.tar.bz2"
build_style=custom-install
short_desc="Tools for managing kernel modules for initramfs"
maintainer="Juan RP <xtraeme@gmail.com>"
checksum=64a0b3b058f2236be1a8138356306c91e5f23f149a131428e4c7d97b1c050728
long_desc="
 The module-init-tools package provides many of the utilities
 needed by Linux systems for managing loadable Linux Kernel Modules. This
 includes depmod, insmod, rmmod, modprobe and tools like modinfo.

 This package uses klibc for use in the initramfs."

Add_dependency build klibc
Add_dependency run klibc

do_install()
{
	local destdir=$XBPS_DESTDIR/$pkgname-$version

	cd $wrksrc
	CFLAGS="-O2 -DCONFIG_NO_BACKWARDS_COMPAT" \
		CC=klcc LD=klcc ./configure --prefix=
	# klibc lacks getc_unlocked, so use getc instead
	sed 's|getc_unlocked|getc|g' -i *.c
	make || return 1

	install -d ${destdir}/usr/lib/klibc/sbin
	for f in depmod modinfo modprobe insmod lsmod rmmod; do
		install -s -m755 ${f} ${destdir}/usr/lib/klibc/sbin
	done
}
