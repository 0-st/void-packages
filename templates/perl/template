# Template build file for 'perl'.
pkgname=perl
version=5.10.0
distfiles="http://www.cpan.org/src/$pkgname-$version.tar.gz"
configure_script="./Configure"
configure_args="-Dusethreads -des -Dprefix=$XBPS_DESTDIR/$pkgname-$version/usr
 -Duselargefiles -Uusesfio -Dinstallstyle=lib/perl5 -Uinstallusrbinperl
 -Dman1dir=$XBPS_DESTDIR/$pkgname-$version/usr/share/man/man1
 -Dman3dir=$XBPS_DESTDIR/$pkgname-$version/usr/share/man/man3"
build_style=configure
short_desc="Practical Extraction and Report Language"
maintainer="Juan RP <xtraeme@gmail.com>"
checksum=94464a0d374fa63226eee56e0bb3d35564f9d8391a1a8d9f0055805ec25f3b2e
long_desc="
 Perl is a general-purpose programming language originally developed
 for text manipulation and now used for a wide range of tasks including
 system administration, web development, network programming, GUI
 development, and more.  The language is intended to be practical (easy
 to use, efficient, complete) rather than beautiful (tiny, elegant,
 minimal).  Its major features are that it's easy to use, supports both
 procedural and object-oriented (OO) programming, has powerful built-in
 support for text processing, and has one of the world's most impressive
 collections of third-party modules."

Add_dependency full glibc

pre_build()
{
	# This fixes the definitions that the perl binary uses to look at
	# prefix and not XBPS_DESTDIR/MASTERDIR.

	if [ "$XBPS_DESTDIR" != "/xbps" ]; then
		sed -i -e "s|$XBPS_DESTDIR\/$pkgname-$version|/usr|g" \
			$wrksrc/config.h
	fi

	sed -i -e "s|/usr/usr|/usr|g" $wrksrc/config.h

	if [ "$XBPS_MASTERDIR" != "/" ]; then
		sed -i -e "s|$XBPS_MASTERDIR||g" $wrksrc/config.h
	fi
}

post_install()
{
	# Remove hardcoded paths of XBPS_DESTDIR.
	local FILES="Config.pm Config_heavy.pl .packlist"
	local opmult="${xbps_machine}-linux-thread-multi"
	local thrdir="${DESTDIR}/usr/lib/perl5/${version}/${opmult}"

	for f in ${FILES}; do
		sed -i -e "s|$DESTDIR||g" ${thrdir}/${f}
	done
	for f in $(find $DESTDIR/usr/bin/ -type f -print); do
		if $(echo $f|grep -q $DESTDIR); then
			sed -i -e "s|$DESTDIR||g" $f
		fi
	done
}
