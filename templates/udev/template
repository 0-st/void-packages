# Template file for 'udev'
pkgname=udev
sourcepkg=$pkgname
version=143
distfiles="${KERNEL_SITE}/utils/kernel/hotplug/udev-${version}.tar.bz2"
build_style=gnu_configure
configure_args="--exec-prefix= --without-selinux --libexecdir=/lib/udev
 --with-rootlibdir=/lib"
short_desc="A userspace implementation of devfs"
maintainer="Juan RP <xtraeme@gmail.com>"
checksum=3406a653533d573baa50bbdcd81a314377ae9506c9d4573aae7ae2e0755d9439
long_desc="
 udev is a implementation of devfs in userspace using sysfs and
 /sbin/hotplug. It requires a 2.5/2.6 kernel to run properly."

openrc_services="udev sysinit"
conf_files="/etc/udev/udev.conf"
subpackages="devel"

Add_dependency full glibc
Add_dependency full procps
Add_dependency full libblkid
Add_dependency full glib
Add_dependency full acl
Add_dependency full libusb-compat
Add_dependency full usbutils 0.82
Add_dependency full pciutils
Add_dependency build gperf

post_install()
{
	# Install some additional rules.
	install -m644 ${FILESDIR}/81-xbps.rules ${DESTDIR}/lib/udev/rules.d
	install -m644 ${wrksrc}/rules/packages/* ${DESTDIR}/lib/udev/rules.d
	# Remove unneeded rules.
	for f in ia64 ppc s390; do
		rm ${DESTDIR}/lib/udev/rules.d/40-${f}.rules
	done

	# Create some devices that are needed by the initramfs.
	install -d $DESTDIR/lib/firmware
	install -d $DESTDIR/lib/udev/devices/pts
	install -d $DESTDIR/lib/udev/devices/shm
	mknod -m0666 $DESTDIR/lib/udev/devices/null c 1 3
	mknod -m0600 $DESTDIR/lib/udev/devices/kmsg c 1 11
	ln -s /proc/self/fd $DESTDIR/lib/udev/devices/fd
	ln -s /proc/self/fd/0 $DESTDIR/lib/udev/devices/stdin
	ln -s /proc/self/fd/1 $DESTDIR/lib/udev/devices/stdout
	ln -s /proc/self/fd/2 $DESTDIR/lib/udev/devices/stderr
	ln -s /proc/kcore $DESTDIR/lib/udev/devices/core

	# Install the OpenRC service
	install -D -m755 ${FILESDIR}/udev.rc ${DESTDIR}/etc/init.d/udev
}
